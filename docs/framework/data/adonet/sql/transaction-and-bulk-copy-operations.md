---
title: Objeto Transaction y operaciones de copia masiva
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: fb27e11f81451d6a982edcf5b88b23861bef3c37
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/22/2019
ms.locfileid: "69938437"
---
# <a name="transaction-and-bulk-copy-operations"></a><span data-ttu-id="b9d17-102">Objeto Transaction y operaciones de copia masiva</span><span class="sxs-lookup"><span data-stu-id="b9d17-102">Transaction and Bulk Copy Operations</span></span>
<span data-ttu-id="b9d17-103">Las operaciones de copia masiva se pueden realizar como operaciones aisladas o como parte de una transacción en varios pasos.</span><span class="sxs-lookup"><span data-stu-id="b9d17-103">Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.</span></span> <span data-ttu-id="b9d17-104">Esta última opción permite realizar más de una operación de copia masiva en la misma transacción, así como otras operaciones de base de datos (como inserciones, actualizaciones y eliminaciones) y, al mismo tiempo, seguir teniendo la posibilidad de confirmar o revertir la transacción entera.</span><span class="sxs-lookup"><span data-stu-id="b9d17-104">This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.</span></span>  
  
 <span data-ttu-id="b9d17-105">De forma predeterminada, las operaciones de copia masiva se realizan como una operación aislada.</span><span class="sxs-lookup"><span data-stu-id="b9d17-105">By default, a bulk copy operation is performed as an isolated operation.</span></span> <span data-ttu-id="b9d17-106">la operación de copia masiva tiene lugar sin transacción, sin la oportunidad de revertirla.</span><span class="sxs-lookup"><span data-stu-id="b9d17-106">The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.</span></span> <span data-ttu-id="b9d17-107">Si necesita revertir toda o parte de la copia masiva cuando se produce un error, puede usar una <xref:System.Data.SqlClient.SqlBulkCopy>transacción administrada por, realizar la operación de copia masiva en una transacción existente o inscribirse en un **System. Transactions**<xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="b9d17-107">If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.</span></span>  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a><span data-ttu-id="b9d17-108">Realización de una operación de copia masiva sin transacción</span><span class="sxs-lookup"><span data-stu-id="b9d17-108">Performing a Non-transacted Bulk Copy Operation</span></span>  
 <span data-ttu-id="b9d17-109">La siguiente aplicación de consola muestra lo que pasa cuando una operación de copia masiva sin transacción encuentra un error a mitad de camino.</span><span class="sxs-lookup"><span data-stu-id="b9d17-109">The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.</span></span>  
  
 <span data-ttu-id="b9d17-110">En el ejemplo, la tabla de origen y la tabla de destino `Identity` incluyen cada una una columna denominada **ProductID**.</span><span class="sxs-lookup"><span data-stu-id="b9d17-110">In the example, the source table and destination table each include an `Identity` column named **ProductID**.</span></span> <span data-ttu-id="b9d17-111">En primer lugar, el código prepara la tabla de destino eliminando todas las filas y, a continuación, insertando una sola fila cuyo **ProductID** se sabe que existe en la tabla de origen.</span><span class="sxs-lookup"><span data-stu-id="b9d17-111">The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table.</span></span> <span data-ttu-id="b9d17-112">De forma predeterminada, se genera un nuevo valor para la columna `Identity` en la tabla de destino por cada fila agregada.</span><span class="sxs-lookup"><span data-stu-id="b9d17-112">By default, a new value for the `Identity` column is generated in the destination table for each row added.</span></span> <span data-ttu-id="b9d17-113">En este ejemplo se establece una opción cuando se abre la conexión que obliga al proceso de carga masiva a utilizar en su lugar los valores `Identity` de la tabla de origen.</span><span class="sxs-lookup"><span data-stu-id="b9d17-113">In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.</span></span>  
  
 <span data-ttu-id="b9d17-114">La operación de copia masiva se ejecuta con la propiedad <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> establecida en 10.</span><span class="sxs-lookup"><span data-stu-id="b9d17-114">The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10.</span></span> <span data-ttu-id="b9d17-115">Cuando la operación encuentra la fila no válida, se produce una excepción.</span><span class="sxs-lookup"><span data-stu-id="b9d17-115">When the operation encounters the invalid row, an exception is thrown.</span></span> <span data-ttu-id="b9d17-116">En este primer ejemplo, la operación de copia masiva es sin transacción.</span><span class="sxs-lookup"><span data-stu-id="b9d17-116">In this first example, the bulk copy operation is non-transacted.</span></span> <span data-ttu-id="b9d17-117">Todos los lotes copiados hasta el punto del error se confirman, el lote que contiene la clave duplicada se revierte y la operación de copia masiva se detiene antes de procesar el resto de los lotes.</span><span class="sxs-lookup"><span data-stu-id="b9d17-117">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="b9d17-118">Este ejemplo no se ejecutará a menos que haya creado las tablas de trabajo como se describe en el ejemplo de configuración de la [copia masiva](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="b9d17-118">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="b9d17-119">Este código se proporciona para mostrar la sintaxis para usar únicamente **SqlBulkCopy** .</span><span class="sxs-lookup"><span data-stu-id="b9d17-119">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="b9d17-120">Si las tablas de origen y de destino se encuentran en la misma instancia de SQL Server, es más fácil y rápido usar una instrucción`INSERT … SELECT` Transact-SQL para copiar los datos.</span><span class="sxs-lookup"><span data-stu-id="b9d17-120">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a><span data-ttu-id="b9d17-121">Realización de una operación de copia masiva dedicada en una transacción</span><span class="sxs-lookup"><span data-stu-id="b9d17-121">Performing a Dedicated Bulk Copy Operation in a Transaction</span></span>  
 <span data-ttu-id="b9d17-122">De forma predeterminada, una operación de copia masiva es su propia transacción.</span><span class="sxs-lookup"><span data-stu-id="b9d17-122">By default, a bulk copy operation is its own transaction.</span></span> <span data-ttu-id="b9d17-123">Si desea realizar una operación de copia masiva dedicada, cree una nueva instancia de <xref:System.Data.SqlClient.SqlBulkCopy> con una cadena de conexión o utilice un objeto <xref:System.Data.SqlClient.SqlConnection> existente sin una transacción activa.</span><span class="sxs-lookup"><span data-stu-id="b9d17-123">When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction.</span></span> <span data-ttu-id="b9d17-124">En cada situación, la operación de copia masiva crea la transacción y, después, la confirma o revierte.</span><span class="sxs-lookup"><span data-stu-id="b9d17-124">In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.</span></span>  
  
 <span data-ttu-id="b9d17-125">Puede especificar explícitamente la opción <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> en el constructor de clases <xref:System.Data.SqlClient.SqlBulkCopy> y provocar de forma explícita una operación de copia masiva para ejecutarla en su propia transacción, lo que da lugar a que cada lote de la operación de copia masiva se ejecute en una transacción distinta.</span><span class="sxs-lookup"><span data-stu-id="b9d17-125">You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="b9d17-126">Dado que diferentes lotes se ejecutan en diferentes transacciones, si se produjera un error durante la operación de copia masiva, todas las filas del lote actual se revertirían, pero las filas de los lotes anteriores permanecerían en la base de datos.</span><span class="sxs-lookup"><span data-stu-id="b9d17-126">Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.</span></span>  
  
 <span data-ttu-id="b9d17-127">La siguiente aplicación de consola es similar a la del ejemplo anterior, pero con una diferencia: en este ejemplo, la operación de copia masiva administra sus propias transacciones.</span><span class="sxs-lookup"><span data-stu-id="b9d17-127">The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.</span></span> <span data-ttu-id="b9d17-128">Todos los lotes copiados hasta el punto del error se confirman, el lote que contiene la clave duplicada se revierte y la operación de copia masiva se detiene antes de procesar el resto de los lotes.</span><span class="sxs-lookup"><span data-stu-id="b9d17-128">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="b9d17-129">Este ejemplo no se ejecutará a menos que haya creado las tablas de trabajo como se describe en el ejemplo de configuración de la [copia masiva](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="b9d17-129">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="b9d17-130">Este código se proporciona para mostrar la sintaxis para usar únicamente **SqlBulkCopy** .</span><span class="sxs-lookup"><span data-stu-id="b9d17-130">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="b9d17-131">Si las tablas de origen y de destino se encuentran en la misma instancia de SQL Server, es más fácil y rápido usar una instrucción`INSERT … SELECT` Transact-SQL para copiar los datos.</span><span class="sxs-lookup"><span data-stu-id="b9d17-131">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a><span data-ttu-id="b9d17-132">Uso de transacciones existentes</span><span class="sxs-lookup"><span data-stu-id="b9d17-132">Using Existing Transactions</span></span>  
 <span data-ttu-id="b9d17-133">Puede especificar un objeto <xref:System.Data.SqlClient.SqlTransaction> existente como un parámetro en un constructor <xref:System.Data.SqlClient.SqlBulkCopy>.</span><span class="sxs-lookup"><span data-stu-id="b9d17-133">You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span> <span data-ttu-id="b9d17-134">En esta situación, la operación de copia masiva se realiza en una transacción existente y no se efectúa cambio alguno en el estado de la transacción (lo que significa que ni se confirma ni se anula).</span><span class="sxs-lookup"><span data-stu-id="b9d17-134">In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).</span></span> <span data-ttu-id="b9d17-135">De esta forma, las aplicaciones pueden incluir la operación de copia masiva en una transacción con otras operaciones de base de datos.</span><span class="sxs-lookup"><span data-stu-id="b9d17-135">This allows an application to include the bulk copy operation in a transaction with other database operations.</span></span> <span data-ttu-id="b9d17-136">No obstante, si no especifica un objeto <xref:System.Data.SqlClient.SqlTransaction> y pasa una referencia nula mientras la conexión tiene una transacción activa, se produce una excepción.</span><span class="sxs-lookup"><span data-stu-id="b9d17-136">However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.</span></span>  
  
 <span data-ttu-id="b9d17-137">Si se produce un error y necesita revertir toda la operación de copia masiva, o si la copia masiva debe ejecutarse como parte de un proceso más grande que se pueda revertir, puede proporcionar un objeto <xref:System.Data.SqlClient.SqlTransaction> al constructor <xref:System.Data.SqlClient.SqlBulkCopy>.</span><span class="sxs-lookup"><span data-stu-id="b9d17-137">If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span>  
  
 <span data-ttu-id="b9d17-138">La siguiente aplicación de consola es similar a la primera (sin transacción), pero con una diferencia: en este ejemplo, la operación de copia masiva se incluye en una transacción externa más grande.</span><span class="sxs-lookup"><span data-stu-id="b9d17-138">The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.</span></span> <span data-ttu-id="b9d17-139">Cuando se produce la infracción de la clave principal, toda la transacción se revierte y no se agrega ninguna fila a la tabla de destino.</span><span class="sxs-lookup"><span data-stu-id="b9d17-139">When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="b9d17-140">Este ejemplo no se ejecutará a menos que haya creado las tablas de trabajo como se describe en el ejemplo de configuración de la [copia masiva](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="b9d17-140">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="b9d17-141">Este código se proporciona para mostrar la sintaxis para usar únicamente **SqlBulkCopy** .</span><span class="sxs-lookup"><span data-stu-id="b9d17-141">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="b9d17-142">Si las tablas de origen y de destino se encuentran en la misma instancia de SQL Server, es más fácil y rápido usar una instrucción`INSERT … SELECT` Transact-SQL para copiar los datos.</span><span class="sxs-lookup"><span data-stu-id="b9d17-142">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a><span data-ttu-id="b9d17-143">Vea también</span><span class="sxs-lookup"><span data-stu-id="b9d17-143">See also</span></span>

- [<span data-ttu-id="b9d17-144">Operaciones de copia masiva en SQL Server</span><span class="sxs-lookup"><span data-stu-id="b9d17-144">Bulk Copy Operations in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)
- [<span data-ttu-id="b9d17-145">Proveedores administrados de ADO.NET y Centro para desarrolladores de DataSet</span><span class="sxs-lookup"><span data-stu-id="b9d17-145">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
