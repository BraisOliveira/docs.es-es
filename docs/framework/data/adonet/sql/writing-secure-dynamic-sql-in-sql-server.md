---
title: Escribir código SQL dinámico y seguro en SQL Server
ms.date: 03/30/2017
ms.assetid: df5512b0-c249-40d2-82f9-f9a2ce6665bc
ms.openlocfilehash: 236fd925740d37c2cccabfcebfb7fcb46361489d
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/08/2019
ms.locfileid: "59107359"
---
# <a name="writing-secure-dynamic-sql-in-sql-server"></a><span data-ttu-id="3a6da-102">Escribir código SQL dinámico y seguro en SQL Server</span><span class="sxs-lookup"><span data-stu-id="3a6da-102">Writing Secure Dynamic SQL in SQL Server</span></span>
<span data-ttu-id="3a6da-103">La inyección de SQL es el proceso por el cual un usuario malintencionado escribe instrucciones de Transact-SQL en lugar de entradas válidas.</span><span class="sxs-lookup"><span data-stu-id="3a6da-103">SQL Injection is the process by which a malicious user enters Transact-SQL statements instead of valid input.</span></span> <span data-ttu-id="3a6da-104">Si la entrada se pasa directamente al servidor sin haber sido validada y si la aplicación ejecuta el código inyectado por error, el ataque podría dañar o destruir datos.</span><span class="sxs-lookup"><span data-stu-id="3a6da-104">If the input is passed directly to the server without being validated and if the application inadvertently executes the injected code, the attack has the potential to damage or destroy data.</span></span>  
  
 <span data-ttu-id="3a6da-105">Cualquier procedimiento que cree instrucciones SQL debe revisarse para comprobar la posible existencia de vulnerabilidades frente a inyección, ya que SQL Server ejecutará todas las consultas sintácticamente válidas que reciba.</span><span class="sxs-lookup"><span data-stu-id="3a6da-105">Any procedure that constructs SQL statements should be reviewed for injection vulnerabilities because SQL Server will execute all syntactically valid queries that it receives.</span></span> <span data-ttu-id="3a6da-106">Incluso los datos con parámetros pueden ser manipulados por un agresor hábil y resuelto.</span><span class="sxs-lookup"><span data-stu-id="3a6da-106">Even parameterized data can be manipulated by a skilled and determined attacker.</span></span> <span data-ttu-id="3a6da-107">Si utiliza SQL dinámico, asegúrese de parametrizar los comandos y no incluya nunca directamente valores de parámetros en la cadena de la consulta.</span><span class="sxs-lookup"><span data-stu-id="3a6da-107">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into the query string.</span></span>  
  
## <a name="anatomy-of-a-sql-injection-attack"></a><span data-ttu-id="3a6da-108">Anatomía de un ataque de inyección de SQL</span><span class="sxs-lookup"><span data-stu-id="3a6da-108">Anatomy of a SQL Injection Attack</span></span>  
 <span data-ttu-id="3a6da-109">El proceso de inyección funciona mediante la finalización prematura de una cadena de texto y la anexión de un comando nuevo.</span><span class="sxs-lookup"><span data-stu-id="3a6da-109">The injection process works by prematurely terminating a text string and appending a new command.</span></span> <span data-ttu-id="3a6da-110">Dado que el comando insertado puede tener cadenas adicionales anexadas antes de ejecutarse, el malhechor termina la cadena inyectada con una marca de comentario "--".</span><span class="sxs-lookup"><span data-stu-id="3a6da-110">Because the inserted command may have additional strings appended to it before it is executed, the malefactor terminates the injected string with a comment mark "--".</span></span> <span data-ttu-id="3a6da-111">El texto posterior se pasa por alto en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="3a6da-111">Subsequent text is ignored at execution time.</span></span> <span data-ttu-id="3a6da-112">Se pueden insertar varios comandos utilizando un delimitador de punto y coma (;).</span><span class="sxs-lookup"><span data-stu-id="3a6da-112">Multiple commands can be inserted using a semicolon (;) delimiter.</span></span>  
  
 <span data-ttu-id="3a6da-113">Siempre que el código SQL inyectado sea sintácticamente correcto, la manipulación no se detecta mediante programación.</span><span class="sxs-lookup"><span data-stu-id="3a6da-113">As long as injected SQL code is syntactically correct, tampering cannot be detected programmatically.</span></span> <span data-ttu-id="3a6da-114">Por lo tanto, debe validar todas las entradas de usuarios y revisar detenidamente el código que ejecuta comandos SQL construidos en el servidor que se esté utilizando.</span><span class="sxs-lookup"><span data-stu-id="3a6da-114">Therefore, you must validate all user input and carefully review code that executes constructed SQL commands in the server that you are using.</span></span> <span data-ttu-id="3a6da-115">No concatene nunca entradas de usuario que no estén validadas.</span><span class="sxs-lookup"><span data-stu-id="3a6da-115">Never concatenate user input that is not validated.</span></span> <span data-ttu-id="3a6da-116">La concatenación de cadena es el punto principal de entrada de inyección de script.</span><span class="sxs-lookup"><span data-stu-id="3a6da-116">String concatenation is the primary point of entry for script injection.</span></span>  
  
 <span data-ttu-id="3a6da-117">A continuación se describen algunas directrices de utilidad:</span><span class="sxs-lookup"><span data-stu-id="3a6da-117">Here are some helpful guidelines:</span></span>  
  
-   <span data-ttu-id="3a6da-118">No compile nunca instrucciones Transact-SQL directamente desde entradas de usuario; utilice procedimientos almacenados para validar entradas de usuario.</span><span class="sxs-lookup"><span data-stu-id="3a6da-118">Never build Transact-SQL statements directly from user input; use stored procedures to validate user input.</span></span>  
  
-   <span data-ttu-id="3a6da-119">Valide las entradas de usuario comprobando el tipo, la longitud, el formato y el intervalo.</span><span class="sxs-lookup"><span data-stu-id="3a6da-119">Validate user input by testing type, length, format, and range.</span></span> <span data-ttu-id="3a6da-120">Utilice la función Transact-SQL QUOTENAME() para anular los nombres del sistema o la función REPLACE() para anular cualquier carácter de una cadena.</span><span class="sxs-lookup"><span data-stu-id="3a6da-120">Use the Transact-SQL QUOTENAME() function to escape system names or the REPLACE() function to escape any character in a string.</span></span>  
  
-   <span data-ttu-id="3a6da-121">Implemente varios niveles de validación en cada nivel de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="3a6da-121">Implement multiple layers of validation in each tier of your application.</span></span>  
  
-   <span data-ttu-id="3a6da-122">Compruebe el tamaño y tipo de los datos de entrada y aplique los límites apropiados.</span><span class="sxs-lookup"><span data-stu-id="3a6da-122">Test the size and data type of input and enforce appropriate limits.</span></span> <span data-ttu-id="3a6da-123">Con ello evitará saturaciones intencionadas del búfer.</span><span class="sxs-lookup"><span data-stu-id="3a6da-123">This can help prevent deliberate buffer overruns.</span></span>  
  
-   <span data-ttu-id="3a6da-124">Pruebe el contenido de variables de cadena y acepte únicamente los valores esperados.</span><span class="sxs-lookup"><span data-stu-id="3a6da-124">Test the content of string variables and accept only expected values.</span></span> <span data-ttu-id="3a6da-125">Rechace entradas que contengan datos binarios, secuencias de escape y caracteres de comentario.</span><span class="sxs-lookup"><span data-stu-id="3a6da-125">Reject entries that contain binary data, escape sequences, and comment characters.</span></span>  
  
-   <span data-ttu-id="3a6da-126">Cuando trabaje con documentos XML, valide todos los datos con su esquema a medida que se escriben.</span><span class="sxs-lookup"><span data-stu-id="3a6da-126">When you are working with XML documents, validate all data against its schema as it is entered.</span></span>  
  
-   <span data-ttu-id="3a6da-127">En entornos de varios niveles, se deben validar todos los datos antes de su admisión en la zona de confianza.</span><span class="sxs-lookup"><span data-stu-id="3a6da-127">In multi-tiered environments, all data should be validated before admission to the trusted zone.</span></span>  
  
-   <span data-ttu-id="3a6da-128">No se aceptan las siguientes cadenas en campos desde el que se pueden construir los nombres de archivo: AUX, CLOCK$, COM1 a COM8, CON, CONFIG$, LPT1 a LPT8, NUL y PRN.</span><span class="sxs-lookup"><span data-stu-id="3a6da-128">Do not accept the following strings in fields from which file names can be constructed: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL, and PRN.</span></span>  
  
-   <span data-ttu-id="3a6da-129">Utilice objetos <xref:System.Data.SqlClient.SqlParameter> con comandos y procedimientos almacenados para proporcionar comprobación de tipos y validación de longitud.</span><span class="sxs-lookup"><span data-stu-id="3a6da-129">Use <xref:System.Data.SqlClient.SqlParameter> objects with stored procedures and commands to provide type checking and length validation.</span></span>  
  
-   <span data-ttu-id="3a6da-130">Utilice expresiones <xref:System.Text.RegularExpressions.Regex> en código cliente para filtrar caracteres no válidos.</span><span class="sxs-lookup"><span data-stu-id="3a6da-130">Use <xref:System.Text.RegularExpressions.Regex> expressions in client code to filter invalid characters.</span></span>  
  
## <a name="dynamic-sql-strategies"></a><span data-ttu-id="3a6da-131">Estrategias de SQL dinámico</span><span class="sxs-lookup"><span data-stu-id="3a6da-131">Dynamic SQL Strategies</span></span>  
 <span data-ttu-id="3a6da-132">La ejecución de instrucciones SQL creadas de manera dinámica en código basado en procedimientos rompe la cadena de propiedad, lo que lleva a que SQL Server compruebe los permisos del llamador en los objetos a los que se obtiene acceso mediante SQL dinámico.</span><span class="sxs-lookup"><span data-stu-id="3a6da-132">Executing dynamically created SQL statements in your procedural code breaks the ownership chain, causing SQL Server to check the permissions of the caller against the objects being accessed by the dynamic SQL.</span></span>  
  
 <span data-ttu-id="3a6da-133">SQL Server tiene métodos para conceder a los usuarios acceso a datos mediante procedimientos almacenados y funciones definidas por el usuario que ejecutan SQL dinámico.</span><span class="sxs-lookup"><span data-stu-id="3a6da-133">SQL Server has methods for granting users access to data using stored procedures and user-defined functions that execute dynamic SQL.</span></span>  
  
-   <span data-ttu-id="3a6da-134">Usar la suplantación con la cláusula EXECUTE AS de Transact-SQL, como se describe en [Personalizar permisos con suplantación en SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="3a6da-134">Using impersonation with the Transact-SQL EXECUTE AS clause, as described in [Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span></span>  
  
-   <span data-ttu-id="3a6da-135">Firmar procedimientos almacenados con certificados, como se describe en [Firmar procedimientos almacenados en SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="3a6da-135">Signing stored procedures with certificates, as described in [Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span></span>  
  
### <a name="execute-as"></a><span data-ttu-id="3a6da-136">EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="3a6da-136">EXECUTE AS</span></span>  
 <span data-ttu-id="3a6da-137">La cláusula EXECUTE AS reemplaza los permisos del llamador por los del usuario especificado en la cláusula EXECUTE AS.</span><span class="sxs-lookup"><span data-stu-id="3a6da-137">The EXECUTE AS clause replaces the permissions of the caller with that of the user specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="3a6da-138">Los procedimientos almacenados anidados o los desencadenadores se ejecutan en el contexto de seguridad del usuario proxy.</span><span class="sxs-lookup"><span data-stu-id="3a6da-138">Nested stored procedures or triggers execute under the security context of the proxy user.</span></span> <span data-ttu-id="3a6da-139">Esto puede interrumpir las aplicaciones que dependen de seguridad por filas o requieren auditoría.</span><span class="sxs-lookup"><span data-stu-id="3a6da-139">This can break applications that rely on row-level security or require auditing.</span></span> <span data-ttu-id="3a6da-140">Algunas funciones que devuelven la identidad del usuario devuelven el usuario especificado en la cláusula EXECUTE AS, no el llamador original.</span><span class="sxs-lookup"><span data-stu-id="3a6da-140">Some functions that return the identity of the user return the user specified in the EXECUTE AS clause, not the original caller.</span></span> <span data-ttu-id="3a6da-141">El contexto de ejecución se revierte al llamador original sólo después de la ejecución o cuando se ha emitido una instrucción REVERT.</span><span class="sxs-lookup"><span data-stu-id="3a6da-141">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
### <a name="certificate-signing"></a><span data-ttu-id="3a6da-142">Firma de certificado</span><span class="sxs-lookup"><span data-stu-id="3a6da-142">Certificate Signing</span></span>  
 <span data-ttu-id="3a6da-143">Cuando se ejecuta un procedimiento almacenado firmado con un certificado, los permisos concedidos al usuario del certificado se combinan con los del llamador.</span><span class="sxs-lookup"><span data-stu-id="3a6da-143">When a stored procedure that has been signed with a certificate executes, the permissions granted to the certificate user are merged with those of the caller.</span></span> <span data-ttu-id="3a6da-144">El contexto de ejecución sigue siendo el mismo; el usuario del certificado no suplanta al llamador.</span><span class="sxs-lookup"><span data-stu-id="3a6da-144">The execution context remains the same; the certificate user does not impersonate the caller.</span></span> <span data-ttu-id="3a6da-145">Los procedimientos almacenados de firma requieren de varios pasos para su implementación.</span><span class="sxs-lookup"><span data-stu-id="3a6da-145">Signing stored procedures requires several steps to implement.</span></span> <span data-ttu-id="3a6da-146">Cada vez que se modifica el procedimiento, debe volver a firmarse.</span><span class="sxs-lookup"><span data-stu-id="3a6da-146">Each time the procedure is modified, it must be re-signed.</span></span>  
  
### <a name="cross-database-access"></a><span data-ttu-id="3a6da-147">Acceso entre bases de datos</span><span class="sxs-lookup"><span data-stu-id="3a6da-147">Cross Database Access</span></span>  
 <span data-ttu-id="3a6da-148">El encadenamiento de propiedad entre bases de datos no funciona en los casos en que se ejecutan instrucciones creadas de forma dinámica.</span><span class="sxs-lookup"><span data-stu-id="3a6da-148">Cross-database ownership chaining does not work in cases where dynamically created SQL statements are executed.</span></span> <span data-ttu-id="3a6da-149">Puede resolver esto en SQL Server mediante la creación de procedimientos almacenados con acceso a otra base de datos y firmando el procedimiento con un certificado que exista en ambas bases de datos.</span><span class="sxs-lookup"><span data-stu-id="3a6da-149">You can work around this in SQL Server by creating a stored procedure that accesses data in another database and signing the procedure with a certificate that exists in both databases.</span></span> <span data-ttu-id="3a6da-150">Con ello el usuario obtiene acceso a los recursos de la base de datos que utiliza el procedimiento sin concederle permisos ni acceso a la base de datos.</span><span class="sxs-lookup"><span data-stu-id="3a6da-150">This gives users access to the database resources used by the procedure without granting them database access or permissions.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="3a6da-151">Recursos externos</span><span class="sxs-lookup"><span data-stu-id="3a6da-151">External Resources</span></span>  
 <span data-ttu-id="3a6da-152">Para obtener más información, vea los siguientes recursos.</span><span class="sxs-lookup"><span data-stu-id="3a6da-152">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="3a6da-153">Recurso</span><span class="sxs-lookup"><span data-stu-id="3a6da-153">Resource</span></span>|<span data-ttu-id="3a6da-154">Descripción</span><span class="sxs-lookup"><span data-stu-id="3a6da-154">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="3a6da-155">[Procedimientos almacenados](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) e [Inyección de código SQL](/sql/relational-databases/security/sql-injection) en los libros en pantalla de SQL Server</span><span class="sxs-lookup"><span data-stu-id="3a6da-155">[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](/sql/relational-databases/security/sql-injection) in SQL Server Books Online</span></span>|<span data-ttu-id="3a6da-156">Temas que describen cómo crear procedimientos almacenados y cómo funciona la inyección de SQL.</span><span class="sxs-lookup"><span data-stu-id="3a6da-156">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="3a6da-157">Vea también</span><span class="sxs-lookup"><span data-stu-id="3a6da-157">See also</span></span>

- [<span data-ttu-id="3a6da-158">Proteger aplicaciones de ADO.NET</span><span class="sxs-lookup"><span data-stu-id="3a6da-158">Securing ADO.NET Applications</span></span>](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)
- [<span data-ttu-id="3a6da-159">Información general sobre la seguridad de SQL Server</span><span class="sxs-lookup"><span data-stu-id="3a6da-159">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)
- [<span data-ttu-id="3a6da-160">Escenarios de seguridad de aplicaciones en SQL Server</span><span class="sxs-lookup"><span data-stu-id="3a6da-160">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="3a6da-161">Administrar permisos con procedimientos almacenados en SQL Server</span><span class="sxs-lookup"><span data-stu-id="3a6da-161">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="3a6da-162">Firmar procedimientos almacenados en SQL Server</span><span class="sxs-lookup"><span data-stu-id="3a6da-162">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="3a6da-163">Personalizar permisos con suplantación en SQL Server</span><span class="sxs-lookup"><span data-stu-id="3a6da-163">Customizing Permissions with Impersonation in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)
- [<span data-ttu-id="3a6da-164">Proveedores administrados de ADO.NET y centro de desarrolladores de DataSet</span><span class="sxs-lookup"><span data-stu-id="3a6da-164">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
