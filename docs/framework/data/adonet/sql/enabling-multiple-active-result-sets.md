---
title: Habilitar conjuntos de resultados activos múltiples
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 576079e4-debe-4ab5-9204-fcbe2ca7a5e2
ms.openlocfilehash: 633aaa4a9540d0895252e56dbeabd97200081fc9
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 04/23/2019
ms.locfileid: "61877687"
---
# <a name="enabling-multiple-active-result-sets"></a><span data-ttu-id="bf075-102">Habilitar conjuntos de resultados activos múltiples</span><span class="sxs-lookup"><span data-stu-id="bf075-102">Enabling Multiple Active Result Sets</span></span>
<span data-ttu-id="bf075-103">MARS (Multiple Active Result Sets, conjuntos de resultados activos múltiples) es una característica que funciona con SQL Server y que permite la ejecución de varios lotes en una sola conexión.</span><span class="sxs-lookup"><span data-stu-id="bf075-103">Multiple Active Result Sets (MARS) is a feature that works with SQL Server to allow the execution of multiple batches on a single connection.</span></span> <span data-ttu-id="bf075-104">Cuando MARS está habilitado para su uso con SQL Server, cada objeto de comando usado agrega una sesión a la conexión.</span><span class="sxs-lookup"><span data-stu-id="bf075-104">When MARS is enabled for use with SQL Server, each command object used adds a session to the connection.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="bf075-105">Una única sesión MARS abre una conexión lógica para MARS y, a continuación, una conexión lógica para cada comando activo.</span><span class="sxs-lookup"><span data-stu-id="bf075-105">A single MARS session opens one logical connection for MARS to use and then one logical connection for each active command.</span></span>  
  
## <a name="enabling-and-disabling-mars-in-the-connection-string"></a><span data-ttu-id="bf075-106">Habilitación y deshabilitación de MARS en la cadena de conexión</span><span class="sxs-lookup"><span data-stu-id="bf075-106">Enabling and Disabling MARS in the Connection String</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="bf075-107">Las siguientes cadenas de conexión utiliza el ejemplo **AdventureWorks** incluido con SQL Server de la base de datos.</span><span class="sxs-lookup"><span data-stu-id="bf075-107">The following connection strings use the sample **AdventureWorks** database included with SQL Server.</span></span> <span data-ttu-id="bf075-108">En las cadenas de conexión proporcionadas se supone que la base de datos está instalada en un servidor llamado MSSQL1.</span><span class="sxs-lookup"><span data-stu-id="bf075-108">The connection strings provided assume that the database is installed on a server named MSSQL1.</span></span> <span data-ttu-id="bf075-109">Modifique la cadena de conexión según sea necesario para su entorno.</span><span class="sxs-lookup"><span data-stu-id="bf075-109">Modify the connection string as necessary for your environment.</span></span>  
  
 <span data-ttu-id="bf075-110">La característica MARS está deshabilitada de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="bf075-110">The MARS feature is disabled by default.</span></span> <span data-ttu-id="bf075-111">Para habilitarla, agregue el par de palabra clave "MultipleActiveResultSets=True" a la cadena de conexión.</span><span class="sxs-lookup"><span data-stu-id="bf075-111">It can be enabled by adding the "MultipleActiveResultSets=True" keyword pair to your connection string.</span></span> <span data-ttu-id="bf075-112">"True" es el único valor válido para habilitar MARS.</span><span class="sxs-lookup"><span data-stu-id="bf075-112">"True" is the only valid value for enabling MARS.</span></span> <span data-ttu-id="bf075-113">En el siguiente ejemplo se muestra cómo conectarse a una instancia de SQL Server y cómo especificar que se debe habilitar MARS.</span><span class="sxs-lookup"><span data-stu-id="bf075-113">The following example demonstrates how to connect to an instance of SQL Server and how to specify that MARS should be enabled.</span></span>  
  
```vb  
Dim connectionString As String = "Data Source=MSSQL1;" & _  
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" & _  
    "MultipleActiveResultSets=True"  
```  
  
```csharp  
string connectionString = "Data Source=MSSQL1;" +   
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" +  
    "MultipleActiveResultSets=True";  
```  
  
 <span data-ttu-id="bf075-114">Para deshabilitarla, agregue el par de palabra clave "MultipleActiveResultSets=False" a la cadena de conexión.</span><span class="sxs-lookup"><span data-stu-id="bf075-114">You can disable MARS by adding the "MultipleActiveResultSets=False" keyword pair to your connection string.</span></span> <span data-ttu-id="bf075-115">"False" es el único valor válido para deshabilitar MARS.</span><span class="sxs-lookup"><span data-stu-id="bf075-115">"False" is the only valid value for disabling MARS.</span></span> <span data-ttu-id="bf075-116">En la siguiente cadena de conexión se muestra cómo deshabilitar MARS.</span><span class="sxs-lookup"><span data-stu-id="bf075-116">The following connection string demonstrates how to disable MARS.</span></span>  
  
```vb  
Dim connectionString As String = "Data Source=MSSQL1;" & _  
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" & _  
    "MultipleActiveResultSets=False"  
```  
  
```csharp  
string connectionString = "Data Source=MSSQL1;" +   
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" +  
    "MultipleActiveResultSets=False";  
```  
  
## <a name="special-considerations-when-using-mars"></a><span data-ttu-id="bf075-117">Consideraciones especiales al utilizar MARS</span><span class="sxs-lookup"><span data-stu-id="bf075-117">Special Considerations When Using MARS</span></span>  
 <span data-ttu-id="bf075-118">En general, no es necesario modificar las aplicaciones existentes para utilizar una conexión habilitada para MARS.</span><span class="sxs-lookup"><span data-stu-id="bf075-118">In general, existing applications should not need modification to use a MARS-enabled connection.</span></span> <span data-ttu-id="bf075-119">No obstante, si desea utilizar las características de MARS en las aplicaciones, debe comprender las siguientes consideraciones especiales.</span><span class="sxs-lookup"><span data-stu-id="bf075-119">However, if you wish to use MARS features in your applications, you should understand the following special considerations.</span></span>  
  
### <a name="statement-interleaving"></a><span data-ttu-id="bf075-120">Entrelazado de instrucciones</span><span class="sxs-lookup"><span data-stu-id="bf075-120">Statement Interleaving</span></span>  
 <span data-ttu-id="bf075-121">Las operaciones MARS se ejecutan de forma sincrónica en el servidor.</span><span class="sxs-lookup"><span data-stu-id="bf075-121">MARS operations execute synchronously on the server.</span></span> <span data-ttu-id="bf075-122">Se permite el entrelazado de las instrucciones SELECT y BULK INSERT.</span><span class="sxs-lookup"><span data-stu-id="bf075-122">Statement interleaving of SELECT and BULK INSERT statements is allowed.</span></span> <span data-ttu-id="bf075-123">Sin embargo, las instrucciones de lenguaje de manipulación de datos (DML) y de lenguaje de definición de datos (DDL) se ejecutan atómicamente.</span><span class="sxs-lookup"><span data-stu-id="bf075-123">However, data manipulation language (DML) and data definition language (DDL) statements execute atomically.</span></span> <span data-ttu-id="bf075-124">Toda instrucción que intente ejecutarse mientras hay un lote atómico en ejecución quedará bloqueada.</span><span class="sxs-lookup"><span data-stu-id="bf075-124">Any statements attempting to execute while an atomic batch is executing are blocked.</span></span> <span data-ttu-id="bf075-125">La ejecución paralela en el servidor no es una característica MARS.</span><span class="sxs-lookup"><span data-stu-id="bf075-125">Parallel execution at the server is not a MARS feature.</span></span>  
  
 <span data-ttu-id="bf075-126">Si se envían dos lotes en una conexión MARS, y uno de ellos contiene una instrucción SELECT y el otro una instrucción DML, la DML puede comenzar la ejecución dentro de la ejecución de la instrucción SELECT.</span><span class="sxs-lookup"><span data-stu-id="bf075-126">If two batches are submitted under a MARS connection, one of them containing a SELECT statement, the other containing a DML statement, the DML can begin execution within execution of the SELECT statement.</span></span> <span data-ttu-id="bf075-127">Sin embargo, la instrucción DML debe ejecutarse hasta su finalización para que la instrucción SELECT pueda progresar.</span><span class="sxs-lookup"><span data-stu-id="bf075-127">However, the DML statement must run to completion before the SELECT statement can make progress.</span></span> <span data-ttu-id="bf075-128">Si ambas instrucciones están en ejecución en la misma transacción, cualquier cambio realizado en una instrucción DML después de que se ha iniciado la ejecución de la instrucción SELECT no se verá en la operación de lectura.</span><span class="sxs-lookup"><span data-stu-id="bf075-128">If both statements are running under the same transaction, any changes made by a DML statement after the SELECT statement has started execution are not visible to the read operation.</span></span>  
  
 <span data-ttu-id="bf075-129">Una instrucción WAITFOR dentro de una instrucción SELECT no produce la transacción mientras está en espera, es decir, hasta que no se produce la primera fila.</span><span class="sxs-lookup"><span data-stu-id="bf075-129">A WAITFOR statement inside a SELECT statement does not yield the transaction while it is waiting, that is, until the first row is produced.</span></span> <span data-ttu-id="bf075-130">Esto implica que mientras una instrucción WAITFOR está esperando, no se puede ejecutar ningún otro lote en la misma conexión.</span><span class="sxs-lookup"><span data-stu-id="bf075-130">This implies that no other batches can execute within the same connection while a WAITFOR statement is waiting.</span></span>  
  
### <a name="mars-session-cache"></a><span data-ttu-id="bf075-131">Caché de sesiones MARS</span><span class="sxs-lookup"><span data-stu-id="bf075-131">MARS Session Cache</span></span>  
 <span data-ttu-id="bf075-132">Cuando se abre una conexión y está habilitado MARS, se crea una sesión lógica que agrega sobrecarga adicional.</span><span class="sxs-lookup"><span data-stu-id="bf075-132">When a connection is opened with MARS enabled, a logical session is created, which adds additional overhead.</span></span> <span data-ttu-id="bf075-133">Para minimizar la sobrecarga y mejorar el rendimiento, **SqlClient** almacena en caché la sesión MARS de una conexión.</span><span class="sxs-lookup"><span data-stu-id="bf075-133">To minimize overhead and enhance performance, **SqlClient** caches the MARS session within a connection.</span></span> <span data-ttu-id="bf075-134">La caché contiene como máximo 10 sesiones MARS.</span><span class="sxs-lookup"><span data-stu-id="bf075-134">The cache contains at most 10 MARS sessions.</span></span> <span data-ttu-id="bf075-135">El usuario no puede ajustar este valor.</span><span class="sxs-lookup"><span data-stu-id="bf075-135">This value is not user adjustable.</span></span> <span data-ttu-id="bf075-136">Si se alcanza el límite de sesiones, se crea una nueva sesión y no se genera un error.</span><span class="sxs-lookup"><span data-stu-id="bf075-136">If the session limit is reached, a new session is created—an error is not generated.</span></span> <span data-ttu-id="bf075-137">La caché y las sesiones contenidas en ella son por conexión; no se comparten entre conexiones.</span><span class="sxs-lookup"><span data-stu-id="bf075-137">The cache and sessions contained in it are per-connection; they are not shared across connections.</span></span> <span data-ttu-id="bf075-138">Cuando se libera una sesión, vuelve al grupo a menos que se haya alcanzado el límite superior del mismo.</span><span class="sxs-lookup"><span data-stu-id="bf075-138">When a session is released, it is returned to the pool unless the pool's upper limit has been reached.</span></span> <span data-ttu-id="bf075-139">Si el grupo de caché está lleno, la sesión se cierra.</span><span class="sxs-lookup"><span data-stu-id="bf075-139">If the cache pool is full, the session is closed.</span></span> <span data-ttu-id="bf075-140">Las sesiones MARS no expiran.</span><span class="sxs-lookup"><span data-stu-id="bf075-140">MARS sessions do not expire.</span></span> <span data-ttu-id="bf075-141">Solo se limpian cuando se elimina el objeto de conexión.</span><span class="sxs-lookup"><span data-stu-id="bf075-141">They are only cleaned up when the connection object is disposed.</span></span> <span data-ttu-id="bf075-142">La caché de sesiones MARS no está precargada.</span><span class="sxs-lookup"><span data-stu-id="bf075-142">The MARS session cache is not preloaded.</span></span> <span data-ttu-id="bf075-143">Se carga cuando la aplicación necesita más sesiones.</span><span class="sxs-lookup"><span data-stu-id="bf075-143">It is loaded as the application requires more sessions.</span></span>  
  
### <a name="thread-safety"></a><span data-ttu-id="bf075-144">Seguridad para subprocesos</span><span class="sxs-lookup"><span data-stu-id="bf075-144">Thread Safety</span></span>  
 <span data-ttu-id="bf075-145">Las operaciones MARS no proporcionan seguridad para subprocesos.</span><span class="sxs-lookup"><span data-stu-id="bf075-145">MARS operations are not thread-safe.</span></span>  
  
### <a name="connection-pooling"></a><span data-ttu-id="bf075-146">Agrupación de conexiones</span><span class="sxs-lookup"><span data-stu-id="bf075-146">Connection Pooling</span></span>  
 <span data-ttu-id="bf075-147">Las conexiones habilitadas para MARS se agrupan como cualquier otra conexión.</span><span class="sxs-lookup"><span data-stu-id="bf075-147">MARS-enabled connections are pooled like any other connection.</span></span> <span data-ttu-id="bf075-148">Si una aplicación abre dos conexiones, una con MARS habilitado y la otra con MARS deshabilitado, las dos conexiones estarán en grupos distintos.</span><span class="sxs-lookup"><span data-stu-id="bf075-148">If an application opens two connections, one with MARS enabled and one with MARS disabled, the two connections are in separate pools.</span></span> <span data-ttu-id="bf075-149">Para obtener más información, vea [Agrupación de conexiones de SQL Server (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md).</span><span class="sxs-lookup"><span data-stu-id="bf075-149">For more information, see [SQL Server Connection Pooling (ADO.NET)](../../../../../docs/framework/data/adonet/sql-server-connection-pooling.md).</span></span>  
  
### <a name="sql-server-batch-execution-environment"></a><span data-ttu-id="bf075-150">Entorno de ejecución por lotes de SQL Server</span><span class="sxs-lookup"><span data-stu-id="bf075-150">SQL Server Batch Execution Environment</span></span>  
 <span data-ttu-id="bf075-151">Cuando se abre una conexión, se define un entorno predeterminado.</span><span class="sxs-lookup"><span data-stu-id="bf075-151">When a connection is opened, a default environment is defined.</span></span> <span data-ttu-id="bf075-152">A continuación, este entorno se copia en una sesión MARS lógica.</span><span class="sxs-lookup"><span data-stu-id="bf075-152">This environment is then copied into a logical MARS session.</span></span>  
  
 <span data-ttu-id="bf075-153">El entorno de ejecución por lotes incluye los siguientes componentes:</span><span class="sxs-lookup"><span data-stu-id="bf075-153">The batch execution environment includes the following components:</span></span>  
  
- <span data-ttu-id="bf075-154">Definición de opciones (por ejemplo, ANSI_NULLS, DATE_FORMAT, LANGUAGE, TEXTSIZE)</span><span class="sxs-lookup"><span data-stu-id="bf075-154">Set options (for example, ANSI_NULLS, DATE_FORMAT, LANGUAGE, TEXTSIZE)</span></span>  
  
- <span data-ttu-id="bf075-155">Contexto de seguridad (rol del usuario o de la aplicación)</span><span class="sxs-lookup"><span data-stu-id="bf075-155">Security context (user/application role)</span></span>  
  
- <span data-ttu-id="bf075-156">Contexto de la base de datos (base de datos actual)</span><span class="sxs-lookup"><span data-stu-id="bf075-156">Database context (current database)</span></span>  
  
- <span data-ttu-id="bf075-157">Las variables de estado de ejecución (por ejemplo, @@ERROR, @@ROWCOUNT, @@FETCH_STATUS @@IDENTITY)</span><span class="sxs-lookup"><span data-stu-id="bf075-157">Execution state variables (for example, @@ERROR, @@ROWCOUNT, @@FETCH_STATUS @@IDENTITY)</span></span>  
  
- <span data-ttu-id="bf075-158">Tablas temporales de nivel superior</span><span class="sxs-lookup"><span data-stu-id="bf075-158">Top-level temporary tables</span></span>  
  
 <span data-ttu-id="bf075-159">Con MARS, hay un entorno de ejecución predeterminado asociado con una conexión.</span><span class="sxs-lookup"><span data-stu-id="bf075-159">With MARS, a default execution environment is associated to a connection.</span></span> <span data-ttu-id="bf075-160">Cada lote nuevo que comienza a ejecutarse en una conexión dada recibe una copia del entorno predeterminado.</span><span class="sxs-lookup"><span data-stu-id="bf075-160">Every new batch that starts executing under a given connection receives a copy of the default environment.</span></span> <span data-ttu-id="bf075-161">Cada vez que se ejecuta código en un lote dado, todos los cambios realizados en el entorno están en el ámbito del lote específico.</span><span class="sxs-lookup"><span data-stu-id="bf075-161">Whenever code is executed under a given batch, all changes made to the environment are scoped to the specific batch.</span></span> <span data-ttu-id="bf075-162">Finalizada la ejecución, la configuración de ejecución se copia en el entorno predeterminado.</span><span class="sxs-lookup"><span data-stu-id="bf075-162">Once execution finishes, the execution settings are copied into the default environment.</span></span> <span data-ttu-id="bf075-163">En el caso de un único lote que emite varios comandos para que se ejecuten de forma secuencial en la misma transacción, la semántica es la misma a la expuesta por las conexiones que implican clientes o servidores anteriores.</span><span class="sxs-lookup"><span data-stu-id="bf075-163">In the case of a single batch issuing several commands to be executed sequentially under the same transaction, semantics are the same as those exposed by connections involving earlier clients or servers.</span></span>  
  
### <a name="parallel-execution"></a><span data-ttu-id="bf075-164">Ejecución paralela</span><span class="sxs-lookup"><span data-stu-id="bf075-164">Parallel Execution</span></span>  
 <span data-ttu-id="bf075-165">MARS no se ha diseñado para quitar todos los requisitos de varias conexiones en una aplicación.</span><span class="sxs-lookup"><span data-stu-id="bf075-165">MARS is not designed to remove all requirements for multiple connections in an application.</span></span> <span data-ttu-id="bf075-166">Si una aplicación necesita la ejecución paralela real de comandos en un servidor, se deben emplear varias conexiones.</span><span class="sxs-lookup"><span data-stu-id="bf075-166">If an application needs true parallel execution of commands against a server, multiple connections should be used.</span></span>  
  
 <span data-ttu-id="bf075-167">Por ejemplo, vamos a analizar la siguiente situación.</span><span class="sxs-lookup"><span data-stu-id="bf075-167">For example, consider the following scenario.</span></span> <span data-ttu-id="bf075-168">Se crean dos objetos de comando, uno para procesar un conjunto de resultados y el otro para actualizar los datos, que comparten una conexión común a través de MARS.</span><span class="sxs-lookup"><span data-stu-id="bf075-168">Two command objects are created, one for processing a result set and another for updating data; they share a common connection via MARS.</span></span> <span data-ttu-id="bf075-169">En este escenario, el `Transaction`.`Commit`</span><span class="sxs-lookup"><span data-stu-id="bf075-169">In this scenario, the `Transaction`.`Commit`</span></span> <span data-ttu-id="bf075-170">se produce un error en la actualización hasta que se han leído todos los resultados en el primer objeto de comando, lo que produce la excepción siguiente:</span><span class="sxs-lookup"><span data-stu-id="bf075-170">fails on the update until all the results have been read on the first command object, yielding the following exception:</span></span>  
  
 <span data-ttu-id="bf075-171">Mensaje: Contexto de transacción en uso por otra sesión.</span><span class="sxs-lookup"><span data-stu-id="bf075-171">Message: Transaction context in use by another session.</span></span>  
  
 <span data-ttu-id="bf075-172">Origen: Proveedor de datos SqlClient de .NET</span><span class="sxs-lookup"><span data-stu-id="bf075-172">Source: .NET SqlClient Data Provider</span></span>  
  
 <span data-ttu-id="bf075-173">Esperado: (NULL)</span><span class="sxs-lookup"><span data-stu-id="bf075-173">Expected: (null)</span></span>  
  
 <span data-ttu-id="bf075-174">Recibido: System.Data.SqlClient.SqlException</span><span class="sxs-lookup"><span data-stu-id="bf075-174">Received: System.Data.SqlClient.SqlException</span></span>  
  
 <span data-ttu-id="bf075-175">Hay tres opciones para solucionar esta situación:</span><span class="sxs-lookup"><span data-stu-id="bf075-175">There are three options for handling this scenario:</span></span>  
  
1. <span data-ttu-id="bf075-176">Iniciar la transacción una vez creado el lector y, así, no forma parte de la transacción.</span><span class="sxs-lookup"><span data-stu-id="bf075-176">Start the transaction after the reader is created, so that it is not part of the transaction.</span></span> <span data-ttu-id="bf075-177">Cada actualización se convierte entonces en su propia transacción.</span><span class="sxs-lookup"><span data-stu-id="bf075-177">Every update then becomes its own transaction.</span></span>  
  
2. <span data-ttu-id="bf075-178">Confirmar todo el trabajo una vez cerrado el lector.</span><span class="sxs-lookup"><span data-stu-id="bf075-178">Commit all work after the reader is closed.</span></span> <span data-ttu-id="bf075-179">Esto puede traer como consecuencia un lote considerable de actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="bf075-179">This has the potential for a substantial batch of updates.</span></span>  
  
3. <span data-ttu-id="bf075-180">No utilizar MARS, sino una conexión distinta para cada objeto de comando que tendría antes de MARS.</span><span class="sxs-lookup"><span data-stu-id="bf075-180">Don't use MARS; instead use a separate connection for each command object as you would have before MARS.</span></span>  
  
### <a name="detecting-mars-support"></a><span data-ttu-id="bf075-181">Detección de compatibilidad con MARS</span><span class="sxs-lookup"><span data-stu-id="bf075-181">Detecting MARS Support</span></span>  
 <span data-ttu-id="bf075-182">Para comprobar la compatibilidad con MARS, una aplicación puede leer el valor `SqlConnection.ServerVersion`.</span><span class="sxs-lookup"><span data-stu-id="bf075-182">An application can check for MARS support by reading the `SqlConnection.ServerVersion` value.</span></span> <span data-ttu-id="bf075-183">El número principal debe ser 9 para SQL Server 2005 y 10 para SQL Server 2008.</span><span class="sxs-lookup"><span data-stu-id="bf075-183">The major number should be 9 for SQL Server 2005 and 10 for SQL Server 2008.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="bf075-184">Vea también</span><span class="sxs-lookup"><span data-stu-id="bf075-184">See also</span></span>

- [<span data-ttu-id="bf075-185">Conjuntos de resultados activos múltiples (MARS)</span><span class="sxs-lookup"><span data-stu-id="bf075-185">Multiple Active Result Sets (MARS)</span></span>](../../../../../docs/framework/data/adonet/sql/multiple-active-result-sets-mars.md)
- [<span data-ttu-id="bf075-186">Proveedores administrados de ADO.NET y Centro para desarrolladores de DataSet</span><span class="sxs-lookup"><span data-stu-id="bf075-186">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
