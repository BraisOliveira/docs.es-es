---
title: Creación de reflejo de la base de datos en SQL Server
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 89befaff-bb46-4290-8382-e67cdb0e3de9
ms.openlocfilehash: 31fb8af4653cefc8027f4061b46b9a29d8d07f8c
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 08/22/2019
ms.locfileid: "69963996"
---
# <a name="database-mirroring-in-sql-server"></a><span data-ttu-id="9c300-102">Creación de reflejo de la base de datos en SQL Server</span><span class="sxs-lookup"><span data-stu-id="9c300-102">Database Mirroring in SQL Server</span></span>
<span data-ttu-id="9c300-103">La creación de reflejo de base de datos de SQL Server permite mantener una copia, o reflejo, de una base de datos de SQL Server en un servidor en modo de espera.</span><span class="sxs-lookup"><span data-stu-id="9c300-103">Database mirroring in SQL Server allows you to keep a copy, or mirror, of a SQL Server database on a standby server.</span></span> <span data-ttu-id="9c300-104">El reflejo garantiza que en todo momento existen dos copias distintas de los datos, lo que proporciona una alta disponibilidad y una completa redundancia de datos.</span><span class="sxs-lookup"><span data-stu-id="9c300-104">Mirroring ensures that two separate copies of the data exist at all times, providing high availability and complete data redundancy.</span></span> <span data-ttu-id="9c300-105">El proveedor de datos .NET para SQL Server ofrece compatibilidad implícita con la creación de reflejo de base de datos; de modo que el desarrollador no tiene que realizar ninguna acción ni escribir ningún código una vez que se ha configurado para una base de datos de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="9c300-105">The .NET Data Provider for SQL Server provides implicit support for database mirroring, so that the developer does not need to take any action or write any code once it has been configured for a SQL Server database.</span></span> <span data-ttu-id="9c300-106">Además, el objeto <xref:System.Data.SqlClient.SqlConnection> admite un modo de conexión explícita que permita proporcionar el nombre de un servidor asociado de conmutación por error en la propiedad <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span><span class="sxs-lookup"><span data-stu-id="9c300-106">In addition, the <xref:System.Data.SqlClient.SqlConnection> object supports an explicit connection mode that allows supplying the name of a failover partner server in the <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span></span>  
  
 <span data-ttu-id="9c300-107">La siguiente secuencia simplificada de eventos tiene lugar para un objeto <xref:System.Data.SqlClient.SqlConnection> que identifica una base de datos configurada para el reflejo:</span><span class="sxs-lookup"><span data-stu-id="9c300-107">The following simplified sequence of events occurs for a <xref:System.Data.SqlClient.SqlConnection> object that targets a database configured for mirroring:</span></span>  
  
1. <span data-ttu-id="9c300-108">La aplicación cliente se conecta correctamente a la base de datos principal y el servidor devuelve el nombre del servidor asociado, el cual se almacena en caché en el cliente.</span><span class="sxs-lookup"><span data-stu-id="9c300-108">The client application successfully connects to the principal database, and the server sends back the name of the partner server, which is then cached on the client.</span></span>  
  
2. <span data-ttu-id="9c300-109">Si el servidor que contiene la base de datos principal da error o se interrumpe la conectividad, se pierde el estado de la conexión y de la transacción.</span><span class="sxs-lookup"><span data-stu-id="9c300-109">If the server containing the principal database fails or connectivity is interrupted, connection and transaction state is lost.</span></span> <span data-ttu-id="9c300-110">La aplicación cliente intenta restablecer la conexión a la base de datos principal pero no lo consigue.</span><span class="sxs-lookup"><span data-stu-id="9c300-110">The client application attempts to re-establish a connection to the principal database and fails.</span></span>  
  
3. <span data-ttu-id="9c300-111">La aplicación cliente intenta entonces de forma transparente establecer una conexión a la base de datos de reflejo del servidor asociado.</span><span class="sxs-lookup"><span data-stu-id="9c300-111">The client application then transparently attempts to establish a connection to the mirror database on the partner server.</span></span> <span data-ttu-id="9c300-112">Si lo consigue, la conexión se redirecciona a la base de datos de reflejo, que se convierte entonces en la nueva base de datos principal.</span><span class="sxs-lookup"><span data-stu-id="9c300-112">If it succeeds, the connection is redirected to the mirror database, which then becomes the new principal database.</span></span>  
  
## <a name="specifying-the-failover-partner-in-the-connection-string"></a><span data-ttu-id="9c300-113">Especificación del asociado de conmutación por error en la cadena de conexión</span><span class="sxs-lookup"><span data-stu-id="9c300-113">Specifying the Failover Partner in the Connection String</span></span>  
 <span data-ttu-id="9c300-114">Si proporciona el nombre de un servidor asociado de conmutación por error en la cadena de conexión, el cliente intenta una conexión al asociado de conmutación por error de forma transparente si la base de datos principal no está disponible cuando la aplicación cliente se conecta por primera vez.</span><span class="sxs-lookup"><span data-stu-id="9c300-114">If you supply the name of a failover partner server in the connection string, the client will transparently attempt a connection with the failover partner if the principal database is unavailable when the client application first connects.</span></span>  
  
```  
";Failover Partner=PartnerServerName"  
```  
  
 <span data-ttu-id="9c300-115">Si omite el nombre del servidor asociado de conmutación por error y la base de datos principal no está disponible cuando la aplicación cliente se conecta por primera vez, se produce una excepción <xref:System.Data.SqlClient.SqlException>.</span><span class="sxs-lookup"><span data-stu-id="9c300-115">If you omit the name of the failover partner server and the principal database is unavailable when the client application first connects then a <xref:System.Data.SqlClient.SqlException> is raised.</span></span>  
  
 <span data-ttu-id="9c300-116">Cuando una <xref:System.Data.SqlClient.SqlConnection> se abre correctamente, el servidor devuelve el nombre del asociado de conmutación por error, que invalida cualquier valor especificado en la cadena de conexión.</span><span class="sxs-lookup"><span data-stu-id="9c300-116">When a <xref:System.Data.SqlClient.SqlConnection> is successfully opened, the failover partner name is returned by the server and supersedes any values supplied in the connection string.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="9c300-117">Se debe especificar de forma explícita el catálogo o el nombre de la base de datos original en la cadena de conexión para los escenarios de creación de reflejos.</span><span class="sxs-lookup"><span data-stu-id="9c300-117">You must explicitly specify the initial catalog or database name in the connection string for database mirroring scenarios.</span></span> <span data-ttu-id="9c300-118">Si el cliente recibe información de conmutación por error sobre una conexión para la que no se ha especificado de forma explícita un catálogo o base de datos original, dicha información no se almacena en caché y la aplicación no intenta una conmutación por error si el servidor principal da error.</span><span class="sxs-lookup"><span data-stu-id="9c300-118">If the client receives failover information on a connection that doesn't have an explicitly specified initial catalog or database, the failover information is not cached and the application does not attempt to fail over if the principal server fails.</span></span> <span data-ttu-id="9c300-119">Si una cadena de conexión tiene un valor para el asociado de conmutación por error, pero no para el catálogo o la base de datos original, se produce una excepción `InvalidArgumentException`.</span><span class="sxs-lookup"><span data-stu-id="9c300-119">If a connection string has a value for the failover partner, but no value for the initial catalog or database, an `InvalidArgumentException` is raised.</span></span>  
  
## <a name="retrieving-the-current-server-name"></a><span data-ttu-id="9c300-120">Recuperación del nombre del servidor actual</span><span class="sxs-lookup"><span data-stu-id="9c300-120">Retrieving the Current Server Name</span></span>  
 <span data-ttu-id="9c300-121">En caso de una conmutación por error, puede recuperar el nombre del servidor al que hay actualmente una conexión mediante la propiedad <xref:System.Data.SqlClient.SqlConnection.DataSource%2A> de un objeto <xref:System.Data.SqlClient.SqlConnection>.</span><span class="sxs-lookup"><span data-stu-id="9c300-121">In the event of a failover, you can retrieve the name of the server to which the current connection is actually connected by using the <xref:System.Data.SqlClient.SqlConnection.DataSource%2A> property of a <xref:System.Data.SqlClient.SqlConnection> object.</span></span> <span data-ttu-id="9c300-122">El siguiente fragmento de código recupera el nombre del servidor activo, suponiendo que la variable de conexión hace referencia a una <xref:System.Data.SqlClient.SqlConnection> abierta.</span><span class="sxs-lookup"><span data-stu-id="9c300-122">The following code fragment retrieves the name of the active server, assuming that the connection variable references an open <xref:System.Data.SqlClient.SqlConnection>.</span></span>  
  
 <span data-ttu-id="9c300-123">Cuando se produce un evento de conmutación por error y se cambia la conexión al servidor reflejado, la propiedad **DataSource** se actualiza para reflejar el nombre del reflejo.</span><span class="sxs-lookup"><span data-stu-id="9c300-123">When a failover event occurs and the connection is switched to the mirror server, the **DataSource** property is updated to reflect the mirror name.</span></span>  
  
```vb  
Dim activeServer As String = connection.DataSource  
```  
  
```csharp  
string activeServer = connection.DataSource;  
```  
  
## <a name="sqlclient-mirroring-behavior"></a><span data-ttu-id="9c300-124">Comportamiento del reflejo de SqlClient</span><span class="sxs-lookup"><span data-stu-id="9c300-124">SqlClient Mirroring Behavior</span></span>  
 <span data-ttu-id="9c300-125">El cliente siempre intenta conectarse al servidor principal actual.</span><span class="sxs-lookup"><span data-stu-id="9c300-125">The client always tries to connect to the current principal server.</span></span> <span data-ttu-id="9c300-126">Si da error, prueba con el asociado de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="9c300-126">If it fails, it tries the failover partner.</span></span> <span data-ttu-id="9c300-127">Si se ha cambiado el rol de la base de datos reflejada al de principal en el servidor asociado, la conexión se realiza correctamente y la nueva asignación principal-reflejada se envía al cliente y se almacena en caché durante la vigencia de la llamada a <xref:System.AppDomain>.</span><span class="sxs-lookup"><span data-stu-id="9c300-127">If the mirror database has already been switched to the principal role on the partner server, the connection succeeds and the new principal-mirror mapping is sent to the client and cached for the lifetime of the calling <xref:System.AppDomain>.</span></span> <span data-ttu-id="9c300-128">No se almacena en el almacenamiento persistente y no está disponible para las conexiones posteriores en un **AppDomain** o proceso diferente.</span><span class="sxs-lookup"><span data-stu-id="9c300-128">It is not stored in persistent storage and is not available for subsequent connections in a different **AppDomain** or process.</span></span> <span data-ttu-id="9c300-129">Sin embargo, está disponible para las conexiones posteriores en el mismo **AppDomain**.</span><span class="sxs-lookup"><span data-stu-id="9c300-129">However, it is available for subsequent connections within the same **AppDomain**.</span></span> <span data-ttu-id="9c300-130">Tenga en cuenta que otro **AppDomain** o proceso que se ejecute en el mismo equipo o en otro diferente tiene siempre su grupo de conexiones, y esas conexiones no se restablecen.</span><span class="sxs-lookup"><span data-stu-id="9c300-130">Note that another **AppDomain** or process running on the same or a different computer always has its pool of connections, and those connections are not reset.</span></span> <span data-ttu-id="9c300-131">En ese caso, si la base de datos principal deja de funcionar, cada proceso o **AppDomain** produce un error una vez y el grupo se borra automáticamente.</span><span class="sxs-lookup"><span data-stu-id="9c300-131">In that case, if the primary database goes down, each process or **AppDomain** fails once, and the pool is automatically cleared.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="9c300-132">En el servidor, la compatibilidad con el reflejo se configura por cada base de datos.</span><span class="sxs-lookup"><span data-stu-id="9c300-132">Mirroring support on the server is configured on a per-database basis.</span></span> <span data-ttu-id="9c300-133">Si se ejecutan operaciones de manipulación de datos en otras bases de datos no incluidas en el conjunto principal/reflejada, o bien con nombres de varias partes o mediante el cambio de la base de datos actual, los cambios en estas otras bases de datos no se propagarán si se produce un error.</span><span class="sxs-lookup"><span data-stu-id="9c300-133">If data manipulation operations are executed against other databases not included in the principal/mirror set, either by using multipart names or by changing the current database, the changes to these other databases do not propagate in the event of failure.</span></span> <span data-ttu-id="9c300-134">Cuando los datos se modifican en una base de datos sin reflejo, no se generan errores.</span><span class="sxs-lookup"><span data-stu-id="9c300-134">No error is generated when data is modified in a database that is not mirrored.</span></span> <span data-ttu-id="9c300-135">El programador deberá valorar los posibles efectos de tales operaciones.</span><span class="sxs-lookup"><span data-stu-id="9c300-135">The developer must evaluate the possible impact of such operations.</span></span>  
  
## <a name="database-mirroring-resources"></a><span data-ttu-id="9c300-136">Recursos de reflejos de base de datos</span><span class="sxs-lookup"><span data-stu-id="9c300-136">Database Mirroring Resources</span></span>  
 <span data-ttu-id="9c300-137">Para obtener documentación conceptual e información sobre la configuración, implementación y administración de la creación de reflejo, vea los siguientes recursos en SQL Server documentación de.</span><span class="sxs-lookup"><span data-stu-id="9c300-137">For conceptual documentation and information on configuring, deploying and administering mirroring, see the following resources in SQL Server documentation.</span></span>  
  
|<span data-ttu-id="9c300-138">Recurso</span><span class="sxs-lookup"><span data-stu-id="9c300-138">Resource</span></span>|<span data-ttu-id="9c300-139">DESCRIPCIÓN</span><span class="sxs-lookup"><span data-stu-id="9c300-139">Description</span></span>|  
|--------------|-----------------|  
|[<span data-ttu-id="9c300-140">Creación de reflejo de la base de datos</span><span class="sxs-lookup"><span data-stu-id="9c300-140">Database Mirroring</span></span>](/sql/database-engine/database-mirroring/database-mirroring-sql-server)|<span data-ttu-id="9c300-141">Describe cómo establecer y configurar la creación de reflejos en SQL Server.</span><span class="sxs-lookup"><span data-stu-id="9c300-141">Describes how to set up and configure mirroring in SQL Server.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="9c300-142">Vea también</span><span class="sxs-lookup"><span data-stu-id="9c300-142">See also</span></span>

- [<span data-ttu-id="9c300-143">Proveedores administrados de ADO.NET y Centro para desarrolladores de DataSet</span><span class="sxs-lookup"><span data-stu-id="9c300-143">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
