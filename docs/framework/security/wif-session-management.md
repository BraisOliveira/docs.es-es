---
title: Administración de sesiones de WIF
ms.date: 03/30/2017
ms.assetid: 98bce126-18a9-401b-b20d-67ee462a5f8a
author: BrucePerlerMS
ms.openlocfilehash: 980d0c6dca9b0b5fadf2d4a841e4c95a9acaff52
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/23/2019
ms.locfileid: "61780086"
---
# <a name="wif-session-management"></a><span data-ttu-id="8d06c-102">Administración de sesiones de WIF</span><span class="sxs-lookup"><span data-stu-id="8d06c-102">WIF Session Management</span></span>
<span data-ttu-id="8d06c-103">Cuando un cliente intenta acceder a un recurso protegido hospedado en un usuario de confianza por primera vez, primero debe autenticarse en un servicio de token de seguridad (STS) que sea de confianza para el usuario de confianza.</span><span class="sxs-lookup"><span data-stu-id="8d06c-103">When a client first tries to access a protected resource that is hosted by a relying party, the client must first authenticate itself to a security token service (STS) that is trusted by the relying party.</span></span> <span data-ttu-id="8d06c-104">Luego el STS emite un token de seguridad al cliente.</span><span class="sxs-lookup"><span data-stu-id="8d06c-104">The STS then issues a security token to the client.</span></span> <span data-ttu-id="8d06c-105">El cliente presenta este token al usuario de confianza, que, entonces, le concede acceso al recurso protegido.</span><span class="sxs-lookup"><span data-stu-id="8d06c-105">The client presents this token to the relying party, which then grants the client access to the protected resource.</span></span> <span data-ttu-id="8d06c-106">Pero no es deseable que el cliente tenga que volver a autenticarse en el STS para cada solicitud, sobre todo porque incluso podría no ser en el mismo equipo o en el mismo dominio que el usuario de confianza.</span><span class="sxs-lookup"><span data-stu-id="8d06c-106">However, you don’t want the client to have to re-authenticate to the STS for each request, especially because it might not even be on the same computer or in the same domain as the relying party.</span></span> <span data-ttu-id="8d06c-107">Así, Windows Identity Foundation (WIF) hace que el cliente y el usuario de confianza establezcan una sesión en la que el cliente usa un token de seguridad de sesión para autenticarse en el usuario de confianza para todas las solicitudes después de la primera.</span><span class="sxs-lookup"><span data-stu-id="8d06c-107">Instead, Windows Identity Foundation (WIF) has the client and relying party establish a session in which the client uses a session security token to authenticate itself to the relying party for all requests after the first request.</span></span> <span data-ttu-id="8d06c-108">El usuario de confianza puede usar este token de seguridad de sesión, que se almacena en una cookie, para reconstruir el elemento <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType> del cliente.</span><span class="sxs-lookup"><span data-stu-id="8d06c-108">The relying party can use this session security token, which is stored inside a cookie, to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span></span>  
  
 <span data-ttu-id="8d06c-109">El STS define qué autenticación debe proporcionar el cliente.</span><span class="sxs-lookup"><span data-stu-id="8d06c-109">The STS defines what authentication the client must provide.</span></span> <span data-ttu-id="8d06c-110">Pero el cliente puede tener varias credenciales con las que se puede autenticar en el STS.</span><span class="sxs-lookup"><span data-stu-id="8d06c-110">However, the client might have multiple credentials with which it can authenticate itself to the STS.</span></span> <span data-ttu-id="8d06c-111">Por ejemplo, puede tener un token de Windows Live, un nombre de usuario y una contraseña, un certificado y una smartkey.</span><span class="sxs-lookup"><span data-stu-id="8d06c-111">For example, it might have a token from Windows Live, a user name and password, a certificate, and a smartkey.</span></span> <span data-ttu-id="8d06c-112">En ese caso, el STS concede al cliente varias identidades, cada una de las cuales corresponde a una de las credenciales que presenta el cliente.</span><span class="sxs-lookup"><span data-stu-id="8d06c-112">In that case, the STS grants the client several identities, with each identity corresponding to one of the credentials that the client presents.</span></span> <span data-ttu-id="8d06c-113">El usuario de confianza puede usar una o varias de estas identidades cuando decide qué nivel de acceso concede al cliente.</span><span class="sxs-lookup"><span data-stu-id="8d06c-113">The relying party can use one or more of these identities when it decides what level of access to grant the client.</span></span>  
  
 <span data-ttu-id="8d06c-114"><xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> se usa para reconstruir el elemento <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType> del cliente, que contiene todas las identidades del cliente en <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span><span class="sxs-lookup"><span data-stu-id="8d06c-114">The <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> is used to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>, which contains all of the client’s identities in <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span></span> <span data-ttu-id="8d06c-115">Cada <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> de la colección contiene los tokens de arranque asociados a esa identidad.</span><span class="sxs-lookup"><span data-stu-id="8d06c-115">Each <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> in the collection contains the bootstrap tokens that are associated with that identity.</span></span>  
  
 <span data-ttu-id="8d06c-116">Si se emite un nuevo token de sesión con el identificador de sesión del token de sesión original, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> no actualiza el token de sesión en la caché de tokens.</span><span class="sxs-lookup"><span data-stu-id="8d06c-116">If a new session token is issued with the session ID of the original session token, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> does not update the session token in the token cache.</span></span> <span data-ttu-id="8d06c-117">Siempre debe crear una instancia de un token de sesión con un identificador de sesión único.</span><span class="sxs-lookup"><span data-stu-id="8d06c-117">You should always instantiate a session token with a unique session ID.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="8d06c-118">Session.SecurityTokenHandler.ReadToken produce una excepción <xref:System.Xml.XmlException> si recibe una entrada no válida; por ejemplo, si la cookie que contiene el token de sesión está dañada.</span><span class="sxs-lookup"><span data-stu-id="8d06c-118">Session.SecurityTokenHandler.ReadToken throws a <xref:System.Xml.XmlException> exception if it receives invalid input; for example, if the cookie that contains the session token is corrupted.</span></span> <span data-ttu-id="8d06c-119">Se recomienda detectar esta excepción y proporcionar un comportamiento específico de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="8d06c-119">We recommend that you catch this exception and provide application-specific behavior.</span></span>  
  
 <span data-ttu-id="8d06c-120">Si una página web protegida contiene una gran cantidad de recursos (por ejemplo, gráficos pequeños) que también están en el dominio protegido, el cliente debe volver a autenticarse en el usuario de confianza para descargar cada uno de esos recursos.</span><span class="sxs-lookup"><span data-stu-id="8d06c-120">If a protected Web page contains lots of resources (such as small graphics) that are also in the protected domain, the client must re-authenticate itself to the relying party to download each of those resources.</span></span> <span data-ttu-id="8d06c-121">El empleo de un token de autenticación de sesión evita la necesidad de autenticarse en el STS para cada solicitud, pero significa que aún se están enviando muchas cookies.</span><span class="sxs-lookup"><span data-stu-id="8d06c-121">Use of a session authentication token avoids the need to authenticate to the STS for each request, but it still means that many cookies are being sent over.</span></span> <span data-ttu-id="8d06c-122">Es posible que quiera configurar la página web de modo que los datos y los recursos importantes se almacenen en el dominio protegido, mientras que los elementos secundarios lo hagan en un dominio no protegido y vinculado desde la página web principal.</span><span class="sxs-lookup"><span data-stu-id="8d06c-122">You might want to set up the Web page so that the important data and resources are stored in the protected domain while minor items are stored in an unprotected domain and linked to from the main Web page.</span></span> <span data-ttu-id="8d06c-123">Además, establezca la ruta de acceso de la cookie de modo que haga referencia solo al dominio protegido.</span><span class="sxs-lookup"><span data-stu-id="8d06c-123">Also, set the cookie path to reference only the protected domain.</span></span>  
  
 <span data-ttu-id="8d06c-124">Para funcionar en modo de referencia, Microsoft recomienda proporcionar un controlador para el evento <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> en el archivo **global.asax.cs** y establecer la propiedad **IsReferenceMode** en el token pasado en la propiedad <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A>.</span><span class="sxs-lookup"><span data-stu-id="8d06c-124">To operate in reference mode, Microsoft recommends providing a handler for the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> event in the **global.asax.cs** file and setting the **IsReferenceMode** property on the token passed in the <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> property.</span></span> <span data-ttu-id="8d06c-125">Estas actualizaciones garantizan que el token de sesión funcione en modo de referencia para cada solicitud y que se prefiera al mero establecimiento de la propiedad <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> en el módulo de autenticación de sesión.</span><span class="sxs-lookup"><span data-stu-id="8d06c-125">These updates will ensure that the session token operates in reference mode for every request and is favored over merely setting the  <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> property on the Session Authentication Module.</span></span>  
  
## <a name="extensibility"></a><span data-ttu-id="8d06c-126">Extensibilidad</span><span class="sxs-lookup"><span data-stu-id="8d06c-126">Extensibility</span></span>  
 <span data-ttu-id="8d06c-127">Puede extender el mecanismo de administración de sesión.</span><span class="sxs-lookup"><span data-stu-id="8d06c-127">You can extend the session management mechanism.</span></span> <span data-ttu-id="8d06c-128">Una razón para hacerlo es mejorar el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="8d06c-128">One reason for this would be to improve the performance.</span></span> <span data-ttu-id="8d06c-129">Por ejemplo, puede crear un controlador de cookies personalizado que transforme u optimice el token de seguridad de sesión entre su estado en memoria y lo que se incluye en la cookie.</span><span class="sxs-lookup"><span data-stu-id="8d06c-129">For example, you could create a custom cookie handler that transforms or optimizes the session security token between its in-memory state and what goes into the cookie.</span></span> <span data-ttu-id="8d06c-130">Para ello, puede configurar la propiedad <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> de <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> para usar un controlador de cookies personalizado que derive de <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="8d06c-130">To do so, you can configure the <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> property of the <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> to use a custom cookie handler that derives from <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span></span> <span data-ttu-id="8d06c-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> es el controlador de cookies predeterminado porque las cookies superan el tamaño permitido para el protocolo de transferencia de hipertexto (HTTP); si usa un controlador de cookies personalizado, debe implementar la fragmentación.</span><span class="sxs-lookup"><span data-stu-id="8d06c-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> is the default cookie handler because the cookies exceed the allowable size for Hypertext Transfer Protocol (HTTP); if you use a custom cookie handler instead, you must implement chunking.</span></span>  
  
 <span data-ttu-id="8d06c-132">Para obtener más información, consulte [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) ejemplo.</span><span class="sxs-lookup"><span data-stu-id="8d06c-132">For more information, see [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) sample.</span></span> <span data-ttu-id="8d06c-133">Este ejemplo muestra una memoria caché de sesión lista para una granja de servidores (en lugar de un elemento tokenreplycache) para que pueda usar sesiones por referencia en lugar de intercambiar cookies grandes; este ejemplo también muestra una manera más sencilla de proteger las cookies de una granja de servidores.</span><span class="sxs-lookup"><span data-stu-id="8d06c-133">This sample shows a farm ready session cache (as opposed to a tokenreplycache) so that you can use sessions by reference instead of exchanging big cookies; this sample also demonstrates an easier way of securing cookies in a farm.</span></span> <span data-ttu-id="8d06c-134">La caché de sesión se basa en WCF.</span><span class="sxs-lookup"><span data-stu-id="8d06c-134">The session cache is WCF-based.</span></span> <span data-ttu-id="8d06c-135">Con respecto a la protección de sesión, el ejemplo muestra una nueva capacidad de WIF 4.5: una transformación de cookies basada en MachineKey que puede activarse con solo pegar el fragmento de código adecuado en web.config. El ejemplo en sí mismo no es una "granja", pero muestra lo que se necesita para hacer que la aplicación esté lista para una granja de servidores.</span><span class="sxs-lookup"><span data-stu-id="8d06c-135">With regard to session securing, the sample demonstrates a new capability in WIF 4.5 of a cookie transform based on MachineKey, which can be activated by simply pasting the appropriate snippet in the web.config. The sample itself is not "farmed", but it demonstrates what you need for making your app farm-ready.</span></span>
