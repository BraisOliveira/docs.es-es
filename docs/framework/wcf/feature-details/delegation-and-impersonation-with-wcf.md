---
title: Delegación y suplantación con WCF
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- impersonation [WCF]
- delegation [WCF]
ms.assetid: 110e60f7-5b03-4b69-b667-31721b8e3152
ms.openlocfilehash: 39b71d3b5cbcfdc8bde3449560587f033c437d50
ms.sourcegitcommit: 205b9a204742e9c77256d43ac9d94c3f82909808
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/10/2019
ms.locfileid: "70856168"
---
# <a name="delegation-and-impersonation-with-wcf"></a><span data-ttu-id="4a49a-102">Delegación y suplantación con WCF</span><span class="sxs-lookup"><span data-stu-id="4a49a-102">Delegation and Impersonation with WCF</span></span>
<span data-ttu-id="4a49a-103">La*suplantación* es una técnica habitual que utilizan los servicios para restringir el acceso de los clientes a los recursos de un dominio de servicio.</span><span class="sxs-lookup"><span data-stu-id="4a49a-103">*Impersonation* is a common technique that services use to restrict client access to a service domain's resources.</span></span> <span data-ttu-id="4a49a-104">Los recursos de dominio de servicio pueden ser recursos de equipo, como archivos locales (suplantación), o un recurso en otro equipo, como un recurso compartido de archivos (delegación).</span><span class="sxs-lookup"><span data-stu-id="4a49a-104">Service domain resources can either be machine resources, such as local files (impersonation), or a resource on another machine, such as a file share (delegation).</span></span> <span data-ttu-id="4a49a-105">Para obtener una aplicación de ejemplo, consulte [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span><span class="sxs-lookup"><span data-stu-id="4a49a-105">For a sample application, see [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span></span> <span data-ttu-id="4a49a-106">Para obtener un ejemplo de cómo usar la suplantación, [consulte Cómo: Suplantar a un cliente en](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)un servicio.</span><span class="sxs-lookup"><span data-stu-id="4a49a-106">For an example of how to use impersonation, see [How to: Impersonate a Client on a Service](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md).</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="4a49a-107">Tenga en cuenta que al suplantar un cliente en un servicio, éste se ejecuta con las credenciales del cliente, que puede tener privilegios más altos que el proceso del servidor.</span><span class="sxs-lookup"><span data-stu-id="4a49a-107">Be aware that when impersonating a client on a service, the service runs with the client's credentials, which may have higher privileges than the server process.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="4a49a-108">Información general</span><span class="sxs-lookup"><span data-stu-id="4a49a-108">Overview</span></span>  
 <span data-ttu-id="4a49a-109">Normalmente, los clientes llaman a un servicio para que éste realice alguna acción en representación de cliente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-109">Typically, clients call a service to have the service perform some action on the client’s behalf.</span></span> <span data-ttu-id="4a49a-110">La suplantación permite al servicio actuar como el cliente cuando realiza la acción.</span><span class="sxs-lookup"><span data-stu-id="4a49a-110">Impersonation allows the service to act as the client while performing the action.</span></span> <span data-ttu-id="4a49a-111">La delegación permite a un servicio front-end enviar la solicitud del cliente a un servicio back-end de modo que éste también puede suplantar al cliente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-111">Delegation allows a front-end service to forward the client’s request to a back-end service in such a way that the back-end service can also impersonate the client.</span></span> <span data-ttu-id="4a49a-112">La suplantación se utiliza habitualmente como modo de comprobar si un cliente está autorizado para realizar una acción concreta, mientras que la delegación es una manera de hacer fluir las funciones de suplantación, junto con la identidad del cliente, a un servicio back-end.</span><span class="sxs-lookup"><span data-stu-id="4a49a-112">Impersonation is most commonly used as a way of checking whether a client is authorized to perform a particular action, while delegation is a way of flowing impersonation capabilities, along with the client’s identity, to a back-end service.</span></span> <span data-ttu-id="4a49a-113">La delegación es una característica del dominio de Windows que puede usarse al realizar una autenticación basada en Kerberos.</span><span class="sxs-lookup"><span data-stu-id="4a49a-113">Delegation is a Windows domain feature that can be used when Kerberos-based authentication is performed.</span></span> <span data-ttu-id="4a49a-114">La delegación es diferente al flujo de identidad y, dado que la delegación transfiere la capacidad de suplantación del cliente sin poseer su contraseña, es una operación que disfruta de privilegios más elevados que el flujo de identidad.</span><span class="sxs-lookup"><span data-stu-id="4a49a-114">Delegation is distinct from identity flow and, because delegation transfers the ability to impersonate the client without possession of the client’s password, it is a much higher privileged operation than identity flow.</span></span>  
  
 <span data-ttu-id="4a49a-115">Tanta la suplantación como la delegación requieren que el cliente posea una identidad de Windows.</span><span class="sxs-lookup"><span data-stu-id="4a49a-115">Both impersonation and delegation require that the client have a Windows identity.</span></span> <span data-ttu-id="4a49a-116">Si el cliente no posee una identidad de Windows, la única opción disponible es hacer fluir la identidad del cliente hasta el segundo servicio.</span><span class="sxs-lookup"><span data-stu-id="4a49a-116">If a client does not possess a Windows identity, then the only option available is to flow the client’s identity to the second service.</span></span>  
  
## <a name="impersonation-basics"></a><span data-ttu-id="4a49a-117">Fundamentos de la suplantación</span><span class="sxs-lookup"><span data-stu-id="4a49a-117">Impersonation Basics</span></span>  
 <span data-ttu-id="4a49a-118">Windows Communication Foundation (WCF) admite la suplantación para diversas credenciales de cliente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-118">Windows Communication Foundation (WCF) supports impersonation for a variety of client credentials.</span></span> <span data-ttu-id="4a49a-119">En este tema se describe la compatibilidad del modelo de servicio para suplantar al autor de la llamada durante la implementación de un método de servicio.</span><span class="sxs-lookup"><span data-stu-id="4a49a-119">This topic describes service model support for impersonating the caller during the implementation of a service method.</span></span> <span data-ttu-id="4a49a-120">También se describen los escenarios de implementación comunes que implican la suplantación y la seguridad de SOAP y las opciones de WCF en estos escenarios.</span><span class="sxs-lookup"><span data-stu-id="4a49a-120">Also discussed are common deployment scenarios involving impersonation and SOAP security and WCF options in these scenarios.</span></span>  
  
 <span data-ttu-id="4a49a-121">Este tema se centra en la suplantación y delegación en WCF cuando se usa la seguridad de SOAP.</span><span class="sxs-lookup"><span data-stu-id="4a49a-121">This topic focuses on impersonation and delegation in WCF when using SOAP security.</span></span> <span data-ttu-id="4a49a-122">También puede usar la suplantación y delegación con WCF al usar la seguridad de transporte, como se describe en uso de la [suplantación con la seguridad de transporte](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span><span class="sxs-lookup"><span data-stu-id="4a49a-122">You can also use impersonation and delegation with WCF when using transport security, as described in [Using Impersonation with Transport Security](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span></span>  
  
## <a name="two-methods"></a><span data-ttu-id="4a49a-123">Dos métodos</span><span class="sxs-lookup"><span data-stu-id="4a49a-123">Two Methods</span></span>  
 <span data-ttu-id="4a49a-124">La seguridad de WCF SOAP tiene dos métodos distintos para realizar la suplantación.</span><span class="sxs-lookup"><span data-stu-id="4a49a-124">WCF SOAP security has two distinct methods for performing impersonation.</span></span> <span data-ttu-id="4a49a-125">El método utilizado depende del enlace.</span><span class="sxs-lookup"><span data-stu-id="4a49a-125">The method used depends on the binding.</span></span> <span data-ttu-id="4a49a-126">El primero es la suplantación de un token de Windows obtenido desde la interfaz de proveedor de compatibilidad para seguridad (SSPI) o la autenticación de Kerberos, que se almacena en la memoria caché en el servicio.</span><span class="sxs-lookup"><span data-stu-id="4a49a-126">One is impersonation from a Windows token obtained from the Security Support Provider Interface (SSPI) or Kerberos authentication, which is then cached on the service.</span></span> <span data-ttu-id="4a49a-127">El segundo es la suplantación de un token de Windows obtenido a partir de las extensiones de Kerberos, denominado en su conjunto *servicio para usuario* (S4U).</span><span class="sxs-lookup"><span data-stu-id="4a49a-127">The second is impersonation from a Windows token obtained from the Kerberos extensions, collectively called *Service-for-User* (S4U).</span></span>  
  
### <a name="cached-token-impersonation"></a><span data-ttu-id="4a49a-128">Suplantación del token almacenado en caché</span><span class="sxs-lookup"><span data-stu-id="4a49a-128">Cached Token Impersonation</span></span>  
 <span data-ttu-id="4a49a-129">Puede realizar la suplantación del token almacenado en caché con lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="4a49a-129">You can perform cached-token impersonation with the following:</span></span>  
  
- <span data-ttu-id="4a49a-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>y <xref:System.ServiceModel.NetTcpBinding> con una credencial de cliente de Windows.</span><span class="sxs-lookup"><span data-stu-id="4a49a-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a Windows client credential.</span></span>  
  
- <span data-ttu-id="4a49a-131"><xref:System.ServiceModel.BasicHttpBinding> con <xref:System.ServiceModel.BasicHttpSecurityMode> definido en la credencial <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> , o cualquier otro enlace estándar donde el cliente presenta una credencial del nombre de usuario que el servicio puede asignar a una cuenta válida de Windows.</span><span class="sxs-lookup"><span data-stu-id="4a49a-131"><xref:System.ServiceModel.BasicHttpBinding> with a <xref:System.ServiceModel.BasicHttpSecurityMode> set to the <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> credential, or any other standard binding where the client presents a user name credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="4a49a-132">Cualquier <xref:System.ServiceModel.Channels.CustomBinding> que utiliza una credencial de cliente de Windows con `requireCancellation` definido en `true`.</span><span class="sxs-lookup"><span data-stu-id="4a49a-132">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` set to `true`.</span></span> <span data-ttu-id="4a49a-133">(La propiedad está disponible en las clases siguientes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters> y <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) Si se utiliza una conversación segura en el enlace, también debe tener la propiedad `requireCancellation` establecida en `true`.</span><span class="sxs-lookup"><span data-stu-id="4a49a-133">(The property is available on the following classes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, and <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) If a secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
- <span data-ttu-id="4a49a-134">Cualquier <xref:System.ServiceModel.Channels.CustomBinding> donde el cliente presenta una credencial de nombre de usuario.</span><span class="sxs-lookup"><span data-stu-id="4a49a-134">Any <xref:System.ServiceModel.Channels.CustomBinding> where the client presents a user name credential.</span></span> <span data-ttu-id="4a49a-135">Si se utiliza una conversación segura en el enlace, también debe tener la propiedad `requireCancellation` establecida en `true`.</span><span class="sxs-lookup"><span data-stu-id="4a49a-135">If secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
### <a name="s4u-based-impersonation"></a><span data-ttu-id="4a49a-136">Suplantación basada en S4U</span><span class="sxs-lookup"><span data-stu-id="4a49a-136">S4U-Based Impersonation</span></span>  
 <span data-ttu-id="4a49a-137">Puede realizar la suplantación basada en S4U con lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="4a49a-137">You can perform S4U-based impersonation with the following:</span></span>  
  
- <span data-ttu-id="4a49a-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>y <xref:System.ServiceModel.NetTcpBinding> con una credencial de certificado de cliente que el servicio puede asignar a una cuenta de Windows válida.</span><span class="sxs-lookup"><span data-stu-id="4a49a-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a certificate client credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="4a49a-139">Cualquier <xref:System.ServiceModel.Channels.CustomBinding> que utiliza una credencial de cliente de Windows con la propiedad `requireCancellation` definida en `false`.</span><span class="sxs-lookup"><span data-stu-id="4a49a-139">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` property set to `false`.</span></span>  
  
- <span data-ttu-id="4a49a-140">Cualquier <xref:System.ServiceModel.Channels.CustomBinding> que utiliza un nombre de usuario o credencial de cliente de Windows y una conversación segura con la propiedad `requireCancellation` establecida en `false`.</span><span class="sxs-lookup"><span data-stu-id="4a49a-140">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a user name or Windows client credential and secure conversation with the `requireCancellation` property set to `false`.</span></span>  
  
 <span data-ttu-id="4a49a-141">Hasta qué punto el servicio puede suplantar al cliente depende de los privilegios que la cuenta de servicio contiene al intentar suplantar, el tipo de suplantación utilizado y posiblemente hasta qué punto el cliente permite la suplantación.</span><span class="sxs-lookup"><span data-stu-id="4a49a-141">The extent to which the service can impersonate the client depends on the privileges the service account holds when it attempts impersonation, the type of impersonation used, and possibly the extent of impersonation the client permits.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="4a49a-142">Cuando el cliente y el servicio se están ejecutando en el mismo equipo y el cliente se está ejecutando bajo una cuenta del sistema (por ejemplo, `Local System` o `Network Service`), no se puede suplantar el cliente cuando una sesión segura se establece con tokens de contexto de seguridad con estado.</span><span class="sxs-lookup"><span data-stu-id="4a49a-142">When the client and service are running on the same computer and the client is running under a system account (for example, `Local System` or `Network Service`), the client cannot be impersonated when a secure session is established with stateful Security Context tokens.</span></span> <span data-ttu-id="4a49a-143">Una aplicación Windows Form o de consola se ejecutan normalmente con la cuenta con la que haya iniciado la sesión, de manera que la cuenta pueda suplantarse de manera predeterminada.</span><span class="sxs-lookup"><span data-stu-id="4a49a-143">A Windows Form or console application typically runs under the currently logged-in account, so that account can be impersonated by default.</span></span> <span data-ttu-id="4a49a-144">Sin embargo, cuando el cliente es una página de ASP.net y esa página se hospeda en IIS 6,0 o IIS 7,0, el cliente se ejecuta en `Network Service` la cuenta de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="4a49a-144">However, when the client is an ASP.NET page and that page is hosted in IIS 6.0 or IIS 7.0, then the client does run under the `Network Service` account by default.</span></span> <span data-ttu-id="4a49a-145">Todos los enlaces proporcionados por el sistema que admiten sesiones seguras utilizan de forma predeterminada un token de contexto de seguridad sin estado (SCT).</span><span class="sxs-lookup"><span data-stu-id="4a49a-145">All of the system-provided bindings that support secure sessions use a stateless security context token (SCT) by default.</span></span> <span data-ttu-id="4a49a-146">Sin embargo, si el cliente es una página de ASP.NET y se usan sesiones seguras con SCT con estado, el cliente no se puede suplantar.</span><span class="sxs-lookup"><span data-stu-id="4a49a-146">However, if the client is an ASP.NET page, and secure sessions with stateful SCTs are used, the client cannot be impersonated.</span></span> <span data-ttu-id="4a49a-147">Para obtener más información sobre el uso de SCT con estado en una sesión [segura, consulte Cómo: Cree un token de contexto de seguridad para una](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md)sesión segura.</span><span class="sxs-lookup"><span data-stu-id="4a49a-147">For more information about using stateful SCTs in a secure session, see [How to: Create a Security Context Token for a Secure Session](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-declarative-model"></a><span data-ttu-id="4a49a-148">Suplantación en un método de servicio: Modelo declarativo</span><span class="sxs-lookup"><span data-stu-id="4a49a-148">Impersonation in a Service Method: Declarative Model</span></span>  
 <span data-ttu-id="4a49a-149">La mayoría de los escenarios de suplantación implican la ejecución del método de servicio en el contexto del autor de llamada.</span><span class="sxs-lookup"><span data-stu-id="4a49a-149">Most impersonation scenarios involve executing the service method in the caller context.</span></span> <span data-ttu-id="4a49a-150">WCF proporciona una característica de suplantación que facilita esta tarea, ya que permite al usuario especificar el requisito de suplantación en <xref:System.ServiceModel.OperationBehaviorAttribute> el atributo.</span><span class="sxs-lookup"><span data-stu-id="4a49a-150">WCF provides an impersonation feature that makes this easy to do by allowing the user to specify the impersonation requirement in the <xref:System.ServiceModel.OperationBehaviorAttribute> attribute.</span></span> <span data-ttu-id="4a49a-151">Por ejemplo, en el código siguiente, la infraestructura de WCF suplanta al llamador antes de ejecutar el `Hello` método.</span><span class="sxs-lookup"><span data-stu-id="4a49a-151">For example, in the following code, the WCF infrastructure impersonates the caller before executing the `Hello` method.</span></span> <span data-ttu-id="4a49a-152">Cualquier intento para tener acceso a los recursos nativos dentro del método `Hello` solo tiene éxito si la lista de control de acceso (ACL) del recurso permite privilegios de acceso al autor de la llamada.</span><span class="sxs-lookup"><span data-stu-id="4a49a-152">Any attempt to access native resources inside the `Hello` method succeed only if the access control list (ACL) of the resource allows the caller access privileges.</span></span> <span data-ttu-id="4a49a-153">Para habilitar la suplantación, establezca la propiedad <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> en uno de los valores de enumeración <xref:System.ServiceModel.ImpersonationOption> , <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> o <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, tal y como se muestra en el ejemplo siguiente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-153">To enable impersonation, set the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property to one of the <xref:System.ServiceModel.ImpersonationOption> enumeration values, either <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> or <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, as shown in the following example.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="4a49a-154">Cuando un servicio tiene las credenciales más altas que el cliente remoto, se utilizan las credenciales del servicio si la propiedad <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> está establecida en <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span><span class="sxs-lookup"><span data-stu-id="4a49a-154">When a service has higher credentials than the remote client, the credentials of the service are used if the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span></span> <span data-ttu-id="4a49a-155">Es decir, si un usuario con pocos privilegios proporciona sus credenciales, un servicio con más privilegios ejecuta el método con las credenciales del servicio y puede utilizar los recursos que el usuario con pocos privilegios no podría utilizar.</span><span class="sxs-lookup"><span data-stu-id="4a49a-155">That is, if a low-privileged user provides its credentials, a higher-privileged service executes the method with the credentials of the service, and can use resources that the low-privileged user would otherwise not be able to use.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#1)]
 [!code-vb[c_ImpersonationAndDelegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#1)]  
  
 <span data-ttu-id="4a49a-156">La infraestructura de WCF solo puede suplantar al autor de la llamada si el autor de la llamada se autentica con credenciales que se pueden asignar a una cuenta de usuario de Windows.</span><span class="sxs-lookup"><span data-stu-id="4a49a-156">The WCF infrastructure can impersonate the caller only if the caller is authenticated with credentials that can be mapped to a Windows user account.</span></span> <span data-ttu-id="4a49a-157">Si el servicio se configura para autenticar utilizando una credencial que no puede estar asignada a una cuenta de Windows, no se ejecutará el método de servicio.</span><span class="sxs-lookup"><span data-stu-id="4a49a-157">If the service is configured to authenticate using a credential that cannot be mapped to a Windows account, the service method is not executed.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="4a49a-158">En [!INCLUDE[wxp](../../../../includes/wxp-md.md)], se produce un error en la suplantación si se crea un SCT con estado dando como resultado <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="4a49a-158">On [!INCLUDE[wxp](../../../../includes/wxp-md.md)], impersonation fails if a stateful SCT is created, resulting in an <xref:System.InvalidOperationException>.</span></span> <span data-ttu-id="4a49a-159">Para obtener más información, vea [escenarios no admitidos](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span><span class="sxs-lookup"><span data-stu-id="4a49a-159">For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-imperative-model"></a><span data-ttu-id="4a49a-160">Suplantación en un método de servicio: Modelo imperativo</span><span class="sxs-lookup"><span data-stu-id="4a49a-160">Impersonation in a Service Method: Imperative Model</span></span>  
 <span data-ttu-id="4a49a-161">En ocasiones, un autor de la llamada no necesita suplantar todo el método de servicio para funcionar, sino solo una parte de él.</span><span class="sxs-lookup"><span data-stu-id="4a49a-161">Sometimes a caller does not need to impersonate the entire service method to function, but for only a portion of it.</span></span> <span data-ttu-id="4a49a-162">En este caso, obtenga la identidad de Windows del autor de la llamada dentro del método de servicio y realice la suplantación inmediatamente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-162">In this case, obtain the Windows identity of the caller inside the service method and imperatively perform the impersonation.</span></span> <span data-ttu-id="4a49a-163">Haga esto utilizando la propiedad <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> de <xref:System.ServiceModel.ServiceSecurityContext> para devolver una instancia de la clase <xref:System.Security.Principal.WindowsIdentity> y llamando al método <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> antes de utilizar la instancia.</span><span class="sxs-lookup"><span data-stu-id="4a49a-163">Do this by using the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property of the <xref:System.ServiceModel.ServiceSecurityContext> to return an instance of the <xref:System.Security.Principal.WindowsIdentity> class and calling the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method before using the instance.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="4a49a-164">Asegúrese de usar la instrucción Visual Basic`Using` o la C# `using` instrucción para revertir automáticamente la acción de suplantación.</span><span class="sxs-lookup"><span data-stu-id="4a49a-164">Be sure to use the Visual Basic`Using` statement or the C# `using` statement to automatically revert the impersonation action.</span></span> <span data-ttu-id="4a49a-165">Si no utiliza la instrucción, o si utiliza un lenguaje de programación distinto de Visual Basic o C#, asegúrese de revertir el nivel de suplantación.</span><span class="sxs-lookup"><span data-stu-id="4a49a-165">If you do not use the statement, or if you use a programming language other than Visual Basic or C#, be sure to revert the impersonation level.</span></span> <span data-ttu-id="4a49a-166">El no hacerlo puede ser la base de la denegación de servicio y aumentar los ataques contra los privilegios.</span><span class="sxs-lookup"><span data-stu-id="4a49a-166">Failure to do this can form the basis for denial of service and elevation of privilege attacks.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#2)]
 [!code-vb[c_ImpersonationAndDelegation#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#2)]  
  
## <a name="impersonation-for-all-service-methods"></a><span data-ttu-id="4a49a-167">Suplantación para todos los métodos de servicio</span><span class="sxs-lookup"><span data-stu-id="4a49a-167">Impersonation for All Service Methods</span></span>  
 <span data-ttu-id="4a49a-168">En algunos casos, debe realizar todos los métodos de un servicio en el contexto del autor de la llamada.</span><span class="sxs-lookup"><span data-stu-id="4a49a-168">In some cases, you must perform all the methods of a service in the caller’s context.</span></span> <span data-ttu-id="4a49a-169">En lugar de habilitar explícitamente esta característica por método, use la clase <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span><span class="sxs-lookup"><span data-stu-id="4a49a-169">Instead of explicitly enabling this feature on a per-method basis, use the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span></span> <span data-ttu-id="4a49a-170">Tal y como se muestra en el código siguiente, defina la propiedad <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> en `true`.</span><span class="sxs-lookup"><span data-stu-id="4a49a-170">As shown in the following code, set the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> property to `true`.</span></span> <span data-ttu-id="4a49a-171"><xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> se recupera de las colecciones de comportamientos de la clase <xref:System.ServiceModel.ServiceHost> .</span><span class="sxs-lookup"><span data-stu-id="4a49a-171">The <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> is retrieved from the collections of behaviors of the <xref:System.ServiceModel.ServiceHost> class.</span></span> <span data-ttu-id="4a49a-172">Además, tenga en cuenta que la propiedad `Impersonation` de <xref:System.ServiceModel.OperationBehaviorAttribute> que se aplica a cada método debe definirse también en <xref:System.ServiceModel.ImpersonationOption.Allowed> o <xref:System.ServiceModel.ImpersonationOption.Required>.</span><span class="sxs-lookup"><span data-stu-id="4a49a-172">Also note that the `Impersonation` property of the <xref:System.ServiceModel.OperationBehaviorAttribute> applied to each method must also be set to either <xref:System.ServiceModel.ImpersonationOption.Allowed> or <xref:System.ServiceModel.ImpersonationOption.Required>.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#3)]
 [!code-vb[c_ImpersonationAndDelegation#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#3)]  
  
 <span data-ttu-id="4a49a-173">En la tabla siguiente se describe el comportamiento de WCF para `ImpersonationOption` todas `ImpersonateCallerForAllServiceOperations`las posibles combinaciones de y.</span><span class="sxs-lookup"><span data-stu-id="4a49a-173">The following table describes WCF behavior for all possible combinations of `ImpersonationOption` and `ImpersonateCallerForAllServiceOperations`.</span></span>  
  
|`ImpersonationOption`|`ImpersonateCallerForAllServiceOperations`|<span data-ttu-id="4a49a-174">Comportamiento</span><span class="sxs-lookup"><span data-stu-id="4a49a-174">Behavior</span></span>|  
|---------------------------|------------------------------------------------|--------------|  
|<span data-ttu-id="4a49a-175">Obligatorio</span><span class="sxs-lookup"><span data-stu-id="4a49a-175">Required</span></span>|<span data-ttu-id="4a49a-176">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-176">n/a</span></span>|<span data-ttu-id="4a49a-177">WCF suplanta al autor de la llamada</span><span class="sxs-lookup"><span data-stu-id="4a49a-177">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="4a49a-178">Permitido</span><span class="sxs-lookup"><span data-stu-id="4a49a-178">Allowed</span></span>|<span data-ttu-id="4a49a-179">false</span><span class="sxs-lookup"><span data-stu-id="4a49a-179">false</span></span>|<span data-ttu-id="4a49a-180">WCF no suplanta al autor de la llamada</span><span class="sxs-lookup"><span data-stu-id="4a49a-180">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="4a49a-181">Permitido</span><span class="sxs-lookup"><span data-stu-id="4a49a-181">Allowed</span></span>|<span data-ttu-id="4a49a-182">true</span><span class="sxs-lookup"><span data-stu-id="4a49a-182">true</span></span>|<span data-ttu-id="4a49a-183">WCF suplanta al autor de la llamada</span><span class="sxs-lookup"><span data-stu-id="4a49a-183">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="4a49a-184">No permitidos</span><span class="sxs-lookup"><span data-stu-id="4a49a-184">NotAllowed</span></span>|<span data-ttu-id="4a49a-185">false</span><span class="sxs-lookup"><span data-stu-id="4a49a-185">false</span></span>|<span data-ttu-id="4a49a-186">WCF no suplanta al autor de la llamada</span><span class="sxs-lookup"><span data-stu-id="4a49a-186">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="4a49a-187">No permitidos</span><span class="sxs-lookup"><span data-stu-id="4a49a-187">NotAllowed</span></span>|<span data-ttu-id="4a49a-188">true</span><span class="sxs-lookup"><span data-stu-id="4a49a-188">true</span></span>|<span data-ttu-id="4a49a-189">No permitido.</span><span class="sxs-lookup"><span data-stu-id="4a49a-189">Disallowed.</span></span> <span data-ttu-id="4a49a-190">(Se produce una excepción <xref:System.InvalidOperationException> .)</span><span class="sxs-lookup"><span data-stu-id="4a49a-190">(An <xref:System.InvalidOperationException> is thrown.)</span></span>|  
  
## <a name="impersonation-level-obtained-from-windows-credentials-and-cached-token-impersonation"></a><span data-ttu-id="4a49a-191">Nivel de suplantación obtenido de las credenciales de Windows y la suplantación de tokens almacenados en caché</span><span class="sxs-lookup"><span data-stu-id="4a49a-191">Impersonation Level Obtained from Windows Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="4a49a-192">En algunos escenarios, el cliente tiene el control parcial sobre el nivel de suplantación que el servicio realiza cuando se utiliza una credencial de cliente de Windows.</span><span class="sxs-lookup"><span data-stu-id="4a49a-192">In some scenarios the client has partial control over the level of impersonation the service performs when a Windows client credential is used.</span></span> <span data-ttu-id="4a49a-193">Se produce un escenario cuando el cliente especifica un nivel de suplantación anónimo.</span><span class="sxs-lookup"><span data-stu-id="4a49a-193">One scenario occurs when the client specifies an Anonymous impersonation level.</span></span> <span data-ttu-id="4a49a-194">El otro se produce cuando se realiza la suplantación con un token en memoria caché.</span><span class="sxs-lookup"><span data-stu-id="4a49a-194">The other occurs when performing impersonation with a cached token.</span></span> <span data-ttu-id="4a49a-195">Esto se realiza estableciendo la propiedad <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> de la clase <xref:System.ServiceModel.Security.WindowsClientCredential> , a la que se obtiene acceso como una propiedad de la clase <xref:System.ServiceModel.ChannelFactory%601> genérica.</span><span class="sxs-lookup"><span data-stu-id="4a49a-195">This is done by setting the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class, which is accessed as a property of the generic <xref:System.ServiceModel.ChannelFactory%601> class.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="4a49a-196">Especificar un nivel de suplantación de anónimo hace que el cliente inicie sesión anónimamente en el servicio.</span><span class="sxs-lookup"><span data-stu-id="4a49a-196">Specifying an impersonation level of Anonymous causes the client to log on to the service anonymously.</span></span> <span data-ttu-id="4a49a-197">Por lo tanto, el servicio debe permitir inicios de sesión anónimos, sin tener en cuenta si se realiza la suplantación.</span><span class="sxs-lookup"><span data-stu-id="4a49a-197">The service must therefore allow anonymous logons, regardless of whether impersonation is performed.</span></span>  
  
 <span data-ttu-id="4a49a-198">El cliente puede especificar el nivel de suplantación como <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>o <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="4a49a-198">The client can specify the impersonation level as <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, or <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="4a49a-199">Se genera solo un token en el nivel especificado, tal y como se muestra en el código siguiente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-199">Only a token at the specified level is produced, as shown in the following code.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#4)]
 [!code-vb[c_ImpersonationAndDelegation#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#4)]  
  
 <span data-ttu-id="4a49a-200">La tabla siguiente especifica el nivel de suplantación que el servicio obtiene al suplantar un token almacenado en memoria caché.</span><span class="sxs-lookup"><span data-stu-id="4a49a-200">The following table specifies the impersonation level the service obtains when impersonating from a cached token.</span></span>  
  
|<span data-ttu-id="4a49a-201">Valor de`AllowedImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="4a49a-201">`AllowedImpersonationLevel` value</span></span>|<span data-ttu-id="4a49a-202">El servicio tiene `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="4a49a-202">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="4a49a-203">El servicio y el cliente tienen capacidad de delegación</span><span class="sxs-lookup"><span data-stu-id="4a49a-203">Service and client are capable of delegation</span></span>|<span data-ttu-id="4a49a-204">`ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="4a49a-204">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="4a49a-205">Anónimas</span><span class="sxs-lookup"><span data-stu-id="4a49a-205">Anonymous</span></span>|<span data-ttu-id="4a49a-206">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-206">Yes</span></span>|<span data-ttu-id="4a49a-207">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-207">n/a</span></span>|<span data-ttu-id="4a49a-208">Suplantación</span><span class="sxs-lookup"><span data-stu-id="4a49a-208">Impersonation</span></span>|  
|<span data-ttu-id="4a49a-209">Anónimas</span><span class="sxs-lookup"><span data-stu-id="4a49a-209">Anonymous</span></span>|<span data-ttu-id="4a49a-210">Sin</span><span class="sxs-lookup"><span data-stu-id="4a49a-210">No</span></span>|<span data-ttu-id="4a49a-211">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-211">n/a</span></span>|<span data-ttu-id="4a49a-212">Identificación</span><span class="sxs-lookup"><span data-stu-id="4a49a-212">Identification</span></span>|  
|<span data-ttu-id="4a49a-213">Identificación</span><span class="sxs-lookup"><span data-stu-id="4a49a-213">Identification</span></span>|<span data-ttu-id="4a49a-214">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-214">n/a</span></span>|<span data-ttu-id="4a49a-215">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-215">n/a</span></span>|<span data-ttu-id="4a49a-216">Identificación</span><span class="sxs-lookup"><span data-stu-id="4a49a-216">Identification</span></span>|  
|<span data-ttu-id="4a49a-217">Suplantación</span><span class="sxs-lookup"><span data-stu-id="4a49a-217">Impersonation</span></span>|<span data-ttu-id="4a49a-218">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-218">Yes</span></span>|<span data-ttu-id="4a49a-219">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-219">n/a</span></span>|<span data-ttu-id="4a49a-220">Suplantación</span><span class="sxs-lookup"><span data-stu-id="4a49a-220">Impersonation</span></span>|  
|<span data-ttu-id="4a49a-221">Suplantación</span><span class="sxs-lookup"><span data-stu-id="4a49a-221">Impersonation</span></span>|<span data-ttu-id="4a49a-222">Sin</span><span class="sxs-lookup"><span data-stu-id="4a49a-222">No</span></span>|<span data-ttu-id="4a49a-223">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-223">n/a</span></span>|<span data-ttu-id="4a49a-224">Identificación</span><span class="sxs-lookup"><span data-stu-id="4a49a-224">Identification</span></span>|  
|<span data-ttu-id="4a49a-225">Delegación</span><span class="sxs-lookup"><span data-stu-id="4a49a-225">Delegation</span></span>|<span data-ttu-id="4a49a-226">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-226">Yes</span></span>|<span data-ttu-id="4a49a-227">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-227">Yes</span></span>|<span data-ttu-id="4a49a-228">Delegación</span><span class="sxs-lookup"><span data-stu-id="4a49a-228">Delegation</span></span>|  
|<span data-ttu-id="4a49a-229">Delegación</span><span class="sxs-lookup"><span data-stu-id="4a49a-229">Delegation</span></span>|<span data-ttu-id="4a49a-230">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-230">Yes</span></span>|<span data-ttu-id="4a49a-231">Sin</span><span class="sxs-lookup"><span data-stu-id="4a49a-231">No</span></span>|<span data-ttu-id="4a49a-232">suplantación</span><span class="sxs-lookup"><span data-stu-id="4a49a-232">Impersonation</span></span>|  
|<span data-ttu-id="4a49a-233">Delegación</span><span class="sxs-lookup"><span data-stu-id="4a49a-233">Delegation</span></span>|<span data-ttu-id="4a49a-234">Sin</span><span class="sxs-lookup"><span data-stu-id="4a49a-234">No</span></span>|<span data-ttu-id="4a49a-235">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-235">n/a</span></span>|<span data-ttu-id="4a49a-236">Identificación</span><span class="sxs-lookup"><span data-stu-id="4a49a-236">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-user-name-credentials-and-cached-token-impersonation"></a><span data-ttu-id="4a49a-237">Nivel de suplantación obtenido a partir de las credenciales de nombre de usuario y suplantación de token almacenado en caché</span><span class="sxs-lookup"><span data-stu-id="4a49a-237">Impersonation Level Obtained from User Name Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="4a49a-238">Al pasar el servicio a su nombre de usuario y contraseña, un cliente permite que WCF inicie sesión como ese usuario, lo que equivale a `AllowedImpersonationLevel` establecer la <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>propiedad en.</span><span class="sxs-lookup"><span data-stu-id="4a49a-238">By passing the service its user name and password, a client enables WCF to log on as that user, which is equivalent to setting the `AllowedImpersonationLevel` property to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="4a49a-239">(`AllowedImpersonationLevel` está disponible en las clases <xref:System.ServiceModel.Security.WindowsClientCredential> y <xref:System.ServiceModel.Security.HttpDigestClientCredential>.) La tabla siguiente proporciona el nivel de suplantación obtenido cuando el servicio recibe las credenciales del nombre de usuario.</span><span class="sxs-lookup"><span data-stu-id="4a49a-239">(The `AllowedImpersonationLevel` is available on the <xref:System.ServiceModel.Security.WindowsClientCredential> and <xref:System.ServiceModel.Security.HttpDigestClientCredential> classes.) The following table provides the impersonation level obtained when the service receives user name credentials.</span></span>  
  
|`AllowedImpersonationLevel`|<span data-ttu-id="4a49a-240">El servicio tiene `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="4a49a-240">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="4a49a-241">El servicio y el cliente tienen capacidad de delegación</span><span class="sxs-lookup"><span data-stu-id="4a49a-241">Service and client are capable of delegation</span></span>|<span data-ttu-id="4a49a-242">`ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="4a49a-242">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="4a49a-243">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-243">n/a</span></span>|<span data-ttu-id="4a49a-244">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-244">Yes</span></span>|<span data-ttu-id="4a49a-245">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-245">Yes</span></span>|<span data-ttu-id="4a49a-246">Delegación</span><span class="sxs-lookup"><span data-stu-id="4a49a-246">Delegation</span></span>|  
|<span data-ttu-id="4a49a-247">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-247">n/a</span></span>|<span data-ttu-id="4a49a-248">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-248">Yes</span></span>|<span data-ttu-id="4a49a-249">Sin</span><span class="sxs-lookup"><span data-stu-id="4a49a-249">No</span></span>|<span data-ttu-id="4a49a-250">Suplantación</span><span class="sxs-lookup"><span data-stu-id="4a49a-250">Impersonation</span></span>|  
|<span data-ttu-id="4a49a-251">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-251">n/a</span></span>|<span data-ttu-id="4a49a-252">Sin</span><span class="sxs-lookup"><span data-stu-id="4a49a-252">No</span></span>|<span data-ttu-id="4a49a-253">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-253">n/a</span></span>|<span data-ttu-id="4a49a-254">Identificación</span><span class="sxs-lookup"><span data-stu-id="4a49a-254">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-s4u-based-impersonation"></a><span data-ttu-id="4a49a-255">Nivel de suplantación obtenido de la suplantación basada en S4U</span><span class="sxs-lookup"><span data-stu-id="4a49a-255">Impersonation Level Obtained from S4U-Based Impersonation</span></span>  
  
|<span data-ttu-id="4a49a-256">El servicio tiene `SeTcbPrivilege`</span><span class="sxs-lookup"><span data-stu-id="4a49a-256">Service has `SeTcbPrivilege`</span></span>|<span data-ttu-id="4a49a-257">El servicio tiene `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="4a49a-257">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="4a49a-258">El servicio y el cliente tienen capacidad de delegación</span><span class="sxs-lookup"><span data-stu-id="4a49a-258">Service and client are capable of delegation</span></span>|<span data-ttu-id="4a49a-259">`ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="4a49a-259">Cached token `ImpersonationLevel`</span></span>|  
|----------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="4a49a-260">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-260">Yes</span></span>|<span data-ttu-id="4a49a-261">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-261">Yes</span></span>|<span data-ttu-id="4a49a-262">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-262">n/a</span></span>|<span data-ttu-id="4a49a-263">Suplantación</span><span class="sxs-lookup"><span data-stu-id="4a49a-263">Impersonation</span></span>|  
|<span data-ttu-id="4a49a-264">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-264">Yes</span></span>|<span data-ttu-id="4a49a-265">Sin</span><span class="sxs-lookup"><span data-stu-id="4a49a-265">No</span></span>|<span data-ttu-id="4a49a-266">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-266">n/a</span></span>|<span data-ttu-id="4a49a-267">Identificación</span><span class="sxs-lookup"><span data-stu-id="4a49a-267">Identification</span></span>|  
|<span data-ttu-id="4a49a-268">Sin</span><span class="sxs-lookup"><span data-stu-id="4a49a-268">No</span></span>|<span data-ttu-id="4a49a-269">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-269">n/a</span></span>|<span data-ttu-id="4a49a-270">N/D</span><span class="sxs-lookup"><span data-stu-id="4a49a-270">n/a</span></span>|<span data-ttu-id="4a49a-271">Identificación</span><span class="sxs-lookup"><span data-stu-id="4a49a-271">Identification</span></span>|  
  
## <a name="mapping-a-client-certificate-to-a-windows-account"></a><span data-ttu-id="4a49a-272">Asignación de un certificado de cliente a una cuenta de Windows</span><span class="sxs-lookup"><span data-stu-id="4a49a-272">Mapping a Client Certificate to a Windows Account</span></span>  
 <span data-ttu-id="4a49a-273">Un cliente se puede autenticar en un servicio mediante un certificado y hacer que el servicio asigne el cliente a una cuenta existente a través de Active Directory.</span><span class="sxs-lookup"><span data-stu-id="4a49a-273">It is possible for a client to authenticate itself to a service using a certificate, and to have the service map the client to an existing account through Active Directory.</span></span> <span data-ttu-id="4a49a-274">En el XML siguiente, se muestra cómo configurar el servicio para asignar el certificado.</span><span class="sxs-lookup"><span data-stu-id="4a49a-274">The following XML shows how to configure the service to map the certificate.</span></span>  
  
```xml  
<behaviors>  
  <serviceBehaviors>  
    <behavior name="MapToWindowsAccount">  
      <serviceCredentials>  
        <clientCertificate>  
          <authentication mapClientCertificateToWindowsAccount="true" />  
        </clientCertificate>  
      </serviceCredentials>  
    </behavior>  
  </serviceBehaviors>  
</behaviors>  
```  
  
 <span data-ttu-id="4a49a-275">En el código siguiente, se muestra cómo configurar el servicio.</span><span class="sxs-lookup"><span data-stu-id="4a49a-275">The following code shows how to configure the service.</span></span>  
  
```csharp
// Create a binding that sets a certificate as the client credential type.  
WSHttpBinding b = new WSHttpBinding();  
b.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;  
  
// Create a service host that maps the certificate to a Windows account.  
Uri httpUri = new Uri("http://localhost/Calculator");  
ServiceHost sh = new ServiceHost(typeof(HelloService), httpUri);  
sh.Credentials.ClientCertificate.Authentication.MapClientCertificateToWindowsAccount = true;  
```  
  
## <a name="delegation"></a><span data-ttu-id="4a49a-276">Delegación</span><span class="sxs-lookup"><span data-stu-id="4a49a-276">Delegation</span></span>  
 <span data-ttu-id="4a49a-277">Para delegar en un servicio back-end, un servicio debe realizar la multibifurcación Kerberos (SSPI sin reserva NTLM), o la autenticación directa de Kerberos en un servicio back-end que utilice la identidad de Windows del cliente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-277">To delegate to a back-end service, a service must perform Kerberos multi-leg (SSPI without NTLM fallback) or Kerberos direct authentication to the back-end service using the client’s Windows identity.</span></span> <span data-ttu-id="4a49a-278">Para delegar en un servicio back-end, cree una clase <xref:System.ServiceModel.ChannelFactory%601> y un canal, y después establezca la comunicación a través del canal al tiempo que suplanta al cliente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-278">To delegate to a back-end service, create a <xref:System.ServiceModel.ChannelFactory%601> and a channel, and then communicate through the channel while impersonating the client.</span></span> <span data-ttu-id="4a49a-279">Con este tipo de delegación, la distancia a la que puede ubicarse el servicio back-end del servicio front-end depende del nivel de suplantación logrado por éste último.</span><span class="sxs-lookup"><span data-stu-id="4a49a-279">With this form of delegation, the distance at which the back-end service can be located from the front-end service depends on the impersonation level achieved by the front-end service.</span></span> <span data-ttu-id="4a49a-280">Cuando el nivel de suplantación es <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, los servicios front-end y back-end deben ejecutarse en el mismo equipo.</span><span class="sxs-lookup"><span data-stu-id="4a49a-280">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, the front-end and back-end services must be running on the same machine.</span></span> <span data-ttu-id="4a49a-281">Cuando el nivel de suplantación es <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, los servicios front-end y back-end pueden ejecutarse en equipos distintos o en el mismo equipo.</span><span class="sxs-lookup"><span data-stu-id="4a49a-281">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, the front-end and back-end services can be on separate machines or on the same machine.</span></span> <span data-ttu-id="4a49a-282">Para habilitar la suplantación en el nivel de delegación es necesario configurar la directiva de dominio de Windows de modo que permita la delegación.</span><span class="sxs-lookup"><span data-stu-id="4a49a-282">Enabling delegation-level impersonation requires that Windows domain policy be configured to permit delegation.</span></span> <span data-ttu-id="4a49a-283">Para obtener más información sobre la configuración de Active Directory para admitir la delegación, consulte [Enabling Delegated Authentication (Habilitar la autenticación delegada)](https://go.microsoft.com/fwlink/?LinkId=99690).</span><span class="sxs-lookup"><span data-stu-id="4a49a-283">For more information about configuring Active Directory for delegation support, see [Enabling Delegated Authentication](https://go.microsoft.com/fwlink/?LinkId=99690).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="4a49a-284">Cuando un cliente se autentica en el servicio front-end mediante un nombre de usuario y una contraseña que se corresponden con una cuenta de Windows del servicio back-end, el servicio front-end puede autenticarse en el servicio back-end volviendo a utilizar el nombre de usuario y la contraseña del cliente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-284">When a client authenticates to the front-end service using a user name and password that correspond to a Windows account on the back-end service, the front-end service can authenticate to the back-end service by reusing the client’s user name and password.</span></span> <span data-ttu-id="4a49a-285">Este es un modo especialmente eficaz de flujo de identidad ya que pasar el nombre de usuario y la contraseña al servicio back-end permite a este último realizar la suplantación, pero no constituye una delegación ya que no se usa Kerberos.</span><span class="sxs-lookup"><span data-stu-id="4a49a-285">This is a particularly powerful form of identity flow, because passing user name and password to the back-end service enables the back-end service to perform impersonation, but it does not constitute delegation because Kerberos is not used.</span></span> <span data-ttu-id="4a49a-286">Active Directory controla la delegación pero no aplica la autenticación del nombre de usuario y la contraseña.</span><span class="sxs-lookup"><span data-stu-id="4a49a-286">Active Directory controls on delegation do not apply to user name and password authentication.</span></span>  
  
### <a name="delegation-ability-as-a-function-of-impersonation-level"></a><span data-ttu-id="4a49a-287">Capacidad de delegación como función del nivel de suplantación</span><span class="sxs-lookup"><span data-stu-id="4a49a-287">Delegation Ability as a Function of Impersonation Level</span></span>  
  
|<span data-ttu-id="4a49a-288">Nivel de suplantación</span><span class="sxs-lookup"><span data-stu-id="4a49a-288">Impersonation level</span></span>|<span data-ttu-id="4a49a-289">El servicio puede realizar una delegación entre procesos</span><span class="sxs-lookup"><span data-stu-id="4a49a-289">Service can perform cross-process delegation</span></span>|<span data-ttu-id="4a49a-290">El servicio puede realizar una delegación entre equipos</span><span class="sxs-lookup"><span data-stu-id="4a49a-290">Service can perform cross-machine delegation</span></span>|  
|-------------------------|---------------------------------------------------|---------------------------------------------------|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Identification>|<span data-ttu-id="4a49a-291">Sin</span><span class="sxs-lookup"><span data-stu-id="4a49a-291">No</span></span>|<span data-ttu-id="4a49a-292">No</span><span class="sxs-lookup"><span data-stu-id="4a49a-292">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>|<span data-ttu-id="4a49a-293">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-293">Yes</span></span>|<span data-ttu-id="4a49a-294">Sin</span><span class="sxs-lookup"><span data-stu-id="4a49a-294">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Delegation>|<span data-ttu-id="4a49a-295">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-295">Yes</span></span>|<span data-ttu-id="4a49a-296">Sí</span><span class="sxs-lookup"><span data-stu-id="4a49a-296">Yes</span></span>|  
  
 <span data-ttu-id="4a49a-297">En el siguiente ejemplo de código se muestra cómo utilizar la delegación.</span><span class="sxs-lookup"><span data-stu-id="4a49a-297">The following code example demonstrates how to use delegation.</span></span>  
  
 [!code-csharp[c_delegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_delegation/cs/source.cs#1)]
 [!code-vb[c_delegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_delegation/vb/source.vb#1)]  
  
### <a name="how-to-configure-an-application-to-use-constrained-delegation"></a><span data-ttu-id="4a49a-298">Cómo: Configurar una aplicación para utilizar la delegación restringida</span><span class="sxs-lookup"><span data-stu-id="4a49a-298">How to Configure an Application to Use Constrained Delegation</span></span>  
 <span data-ttu-id="4a49a-299">Antes de poder utilizar la delegación restringida, debe configurarse el emisor, el receptor y el controlador de dominio para poder utilizarla.</span><span class="sxs-lookup"><span data-stu-id="4a49a-299">Before you can use constrained delegation, the sender, receiver, and the domain controller must be configured to do so.</span></span> <span data-ttu-id="4a49a-300">La siguiente lista de procedimiento enumera los pasos para habilitar la delegación restringida.</span><span class="sxs-lookup"><span data-stu-id="4a49a-300">The following procedure lists the steps that enable constrained delegation.</span></span> <span data-ttu-id="4a49a-301">Para obtener más información sobre las diferencias entre la delegación y la delegación restringida, consulte la parte de [Windows Server 2003 Kerberos Extensions (Extensiones Kerberos de Windows Server 2003)](https://go.microsoft.com/fwlink/?LinkId=100194) en la que se explica la delegación restringida.</span><span class="sxs-lookup"><span data-stu-id="4a49a-301">For details about the differences between delegation and constrained delegation, see the portion of [Windows Server 2003 Kerberos Extensions](https://go.microsoft.com/fwlink/?LinkId=100194) that discusses constrained discussion.</span></span>  
  
1. <span data-ttu-id="4a49a-302">En el controlador de dominio, desactive la casilla **La cuenta es importante y no se puede delegar** de la cuenta con la que se está ejecutando la aplicación cliente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-302">On the domain controller, clear the **Account is sensitive and cannot be delegated** check box for the account under which the client application is running.</span></span>  
  
2. <span data-ttu-id="4a49a-303">En el controlador de dominio, active la casilla **La cuenta es de confianza para la delegación** para la cuenta con la que se está ejecutando la aplicación cliente.</span><span class="sxs-lookup"><span data-stu-id="4a49a-303">On the domain controller, select the **Account is trusted for delegation** check box for the account under which the client application is running.</span></span>  
  
3. <span data-ttu-id="4a49a-304">En el controlador de domino, configure el equipo de nivel medio de modo que sea de confianza para la delegación haciendo clic en la opción **Equipo de confianza para la delegación** .</span><span class="sxs-lookup"><span data-stu-id="4a49a-304">On the domain controller, configure the middle tier computer so that it is trusted for delegation, by clicking the **Trust computer for delegation** option.</span></span>  
  
4. <span data-ttu-id="4a49a-305">En el controlador de domino, configure el equipo de nivel medio para utilizar la delegación restringida haciendo clic en la opción **Confiar en este equipo solo para delegación en servicios especificados** .</span><span class="sxs-lookup"><span data-stu-id="4a49a-305">On the domain controller, configure the middle tier computer to use constrained delegation, by clicking the **Trust this computer for delegation to specified services only** option.</span></span>  
  
 <span data-ttu-id="4a49a-306">Para obtener instrucciones detalladas acerca de la configuración de la delegación restringida, vea los siguientes temas en MSDN:</span><span class="sxs-lookup"><span data-stu-id="4a49a-306">For more detailed instructions about configuring constrained delegation, see the following topics on MSDN:</span></span>  
  
- [<span data-ttu-id="4a49a-307">Solucionar los errores de la delegación Kerberos</span><span class="sxs-lookup"><span data-stu-id="4a49a-307">Troubleshooting Kerberos Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36724)  
  
- [<span data-ttu-id="4a49a-308">Delegación restringida y transición del protocolo Kerberos</span><span class="sxs-lookup"><span data-stu-id="4a49a-308">Kerberos Protocol Transition and Constrained Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36725)  
  
## <a name="see-also"></a><span data-ttu-id="4a49a-309">Vea también</span><span class="sxs-lookup"><span data-stu-id="4a49a-309">See also</span></span>

- <xref:System.ServiceModel.OperationBehaviorAttribute>
- <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A>
- <xref:System.ServiceModel.ImpersonationOption>
- <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A>
- <xref:System.ServiceModel.ServiceSecurityContext>
- <xref:System.Security.Principal.WindowsIdentity>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A>
- <xref:System.ServiceModel.ServiceHost>
- <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ChannelFactory%601>
- <xref:System.Security.Principal.TokenImpersonationLevel.Identification>
- [<span data-ttu-id="4a49a-310">Utilización de la suplantación con la seguridad de transporte</span><span class="sxs-lookup"><span data-stu-id="4a49a-310">Using Impersonation with Transport Security</span></span>](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md)
- [<span data-ttu-id="4a49a-311">Suplantación del cliente</span><span class="sxs-lookup"><span data-stu-id="4a49a-311">Impersonating the Client</span></span>](../../../../docs/framework/wcf/samples/impersonating-the-client.md)
- [<span data-ttu-id="4a49a-312">Cómo: Suplantar a un cliente en un servicio</span><span class="sxs-lookup"><span data-stu-id="4a49a-312">How to: Impersonate a Client on a Service</span></span>](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)
- [<span data-ttu-id="4a49a-313">Herramienta de utilidad de metadatos de ServiceModel (Svcutil.exe)</span><span class="sxs-lookup"><span data-stu-id="4a49a-313">ServiceModel Metadata Utility Tool (Svcutil.exe)</span></span>](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)
